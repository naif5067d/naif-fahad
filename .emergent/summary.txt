<analysis>**original_problem_statement:**
The user wants to build DAR AL CODE HR OS, a mobile-first, enterprise-grade HR operating system for an engineering consultancy.

**LATEST USER REQUIREMENTS (from this session):**
1.  **Map Feature (Work Locations):**
    *   Use a free map service (like OpenStreetMap).
    *   Roles 'Sultan' and 'Naif' can pin locations on the map, defining a work site.
    *   Each site should have a configurable radius (e.g., 500m) for geo-fencing.
    *   Admins can assign employees (from a dropdown) to one or more locations, specifying work days and times.
    *   'STAS' has read-only access to this feature.
    *   Employees should see their assigned work locations in their profiles.
2.  **New Transaction Types:** The user wants to add more specific transaction types, categorized as follows:
    *   **Leave Requests:** Annual Leave, Sick Leave (requires PDF attachment), Unpaid Leave, Marriage Leave, Bereavement Leave, Official Government Leave, Exam Leave.
    *   **Attendance Requests:** Forgot Check-in/out, External Mission, Early Departure, Late Arrival, Manual Entry by Admin, Organizational Note.
    *   All requests should appear in the same central Transactions list for management.
3.  **UI/UX & Role-Specific Fixes:**
    *   **PDF Formatting:** The layout and text organization of generated PDFs need to be improved.
    *   **Supervisor Assignment:** A UI feature for 'Sultan' and 'Naif' to assign/change an employee's supervisor from the employee list page.
    *   **Contract Deletion:** A delete option for contracts, visible only to the 'STAS' role.
    *   **Missing CEO View:** The user Mohammed (CEO) is missing from the user switcher. A view needs to be created for him to see escalated requests and his own transaction history.
4.  **Arabic Language Support:** The user reported issues with Arabic text appearing reversed or disconnected in the PDF and transaction previews. This was addressed, but needs verification.
5.  **Color Coding:** The user wants the color of a pending transaction to reflect the role of the *current required approver*. For example, a transaction Pending Supervisor should have the color assigned to the  role (dark blue).

**User's preferred language**: The user communicates technical requirements in English and provides UI/UX feedback in Arabic. The next agent must respond in the language used by the user for that specific message. Default to English for planning.

**what currently exists?**
The application is a full-stack React/FastAPI/MongoDB HR system. The core RBAC, transaction, and ledger systems are functional. In this session, several critical fixes and features were added:
-   The supervisor self-approval workflow bug was fixed and verified.
-   The UI now supports full Arabic localization, dynamically translating backend data like transaction types and stages.
-   A new color-coding system for transaction statuses has been implemented, where the color reflects the role of the next approver.
-   The backend PDF generation was fixed to correctly render RTL Arabic text.
-   The foundation for a Work Locations (map) feature has been created, including backend CRUD APIs, a database model, and a basic frontend page with Leaflet installed.

**Last working item**:
-   Last item agent was working: The agent had just received a comprehensive list of new features and fixes from the user (see LATEST USER REQUIREMENTS above). The agent acknowledged these requirements and was about to start implementation, beginning with the color-coding changes.
-   Status: NOT STARTED (on the large batch of new requests).
-   Agent Testing Done: Y (for the work completed *before* the new requests arrived).
-   Which testing method agent to use? both (Frontend for UI changes, Backend for new transaction logic and API endpoints).
-   User Testing Done: N (User has not yet verified the latest fixes and has provided new requirements instead).

**All Pending/In progress Issue list**:
-   **Issue 1: Missing CEO (Mohammed) Account (P0)**
-   **Issue 2: Poor PDF Formatting (P1)**
-   **Issue 3: Verify Status/Role Color Implementation (P2)**

**Issues Detail:**
-   **Issue 1: Missing CEO (Mohammed) Account**
    -   **Attempted fixes:** None. The issue was just reported.
    -   **Next debug checklist:**
        1.  Check  or the component containing the user switcher.
        2.  Verify if the API response from  includes the Mohammed user.
        3.  If the user is missing from the frontend list, add him.
        4.  Create a dedicated view/dashboard for the CEO role that shows escalated transactions and his personal requests.
    -   **Why fix this issue and what will be achieved with the fix?** The CEO is a critical role in the approval workflow and currently has no access to the system via the UI.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
-   **Issue 2: Poor PDF Formatting**
    -   **Attempted fixes:** The agent fixed the Arabic text rendering, but not the overall layout.
    -   **Next debug checklist:**
        1.  Review .
        2.  Restructure the placement of text, headers, and tables using  coordinates to create a more professional and organized document.
        3.  Ensure consistent styling and spacing.
    -   **Why fix this issue and what will be achieved with the fix?** The generated PDFs are official records and must be clear, professional, and well-organized.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
-   **Issue 3: Verify Status/Role Color Implementation**
    -   **Attempted fixes:** The agent implemented logic to change status colors based on the approver's role.
    -   **Next debug checklist:**
        1.  Review the logic in  and .
        2.  Cross-reference the implemented colors with the user's explicit list.
        3.  Create transactions that go through each stage of the workflow and verify in the UI that the color updates correctly at each step.
    -   **Why fix this issue and what will be achieved with the fix?** The user has repeatedly mentioned this. Verifying it will ensure the UI meets their exact specifications and prevent further requests on this topic.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend

**In progress Task List**:
-   **Task 1: Complete Work Locations Map Feature (P1)**

**Task Detail:**
-   **Task 1: Complete Work Locations Map Feature**
    -   **Where to resume:** The backend API () and a basic frontend page () exist. The next step is to build out the UI on the frontend page to:
        1.  Display the Leaflet map.
        2.  Allow admins ('Sultan', 'Naif') to click the map to add a pin (a new work location).
        3.  Show a form to name the location and define its properties (e.g., 500m radius).
        4.  Add a multi-select dropdown (populated from ) to assign employees to the selected location.
        5.  Implement logic to link employees to locations in the database via the API.
    -   **What will be achieved with this?** It will deliver a major user-requested feature for managing employee work sites.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Implement New Transaction Types:** Modify  and  (or create new routes) to handle the new, specific request types. Update the frontend to allow users to select these new types when creating a request.
    -   **P1: Supervisor Assignment UI:** Add a feature to the Employees page () allowing 'Sultan'/'Naif' to change an employee's . This should likely trigger a formal transaction for STAS approval.
    -   **P1: Contract Deletion for STAS:** Add a delete button on the contracts page, visible only to users with the 'STAS' role, that calls a new backend endpoint to delete contracts.
-   **Future Tasks:**
    -   Full implementation of contract versioning and snapshots.
    -   Build out the remaining ledgers (Warning, Asset) with corresponding transaction types.

**Completed work in this session**
-   Fixed the critical regression where a supervisor's leave request would get stuck pending their own approval.
-   Implemented full Arabic localization for dynamic content (transaction types, statuses) and fixed RTL text rendering in PDFs.
-   Implemented the user's requested color-coding scheme for transaction statuses based on the current approver's role color.
-   Created the backend API, database model, and initial frontend page for the Work Locations (map) feature.

**Earlier issues found/mentioned but not fixed**
All new issues and tasks mentioned in the user's last message () are now captured in the Pending Issues and Upcoming Tasks sections above.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** The supervisor self-approval workflow bug.
-   **Recurrence count:** 2
-   **Status:** RESOLVED

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Python, MongoDB (), 
-   **Frontend:** React.js, Tailwind CSS, shadcn/ui, , , , 
-   **Authentication:** Custom JWT with Role-Based Access Control (RBAC).
-   **Architecture:** Modular backend with distinct engines for workflow logic.

**key DB schema**
-   , , , , , , ,  (Existing)
-   : {name, latitude, longitude, radius, assigned_employees: [employee_id]} (NEW)

**changes in tech stack**
-   Added  and  for the map feature.

**All files of reference**
-   : Contains the fixed supervisor skip logic.
-   : Contains the fix for Arabic text rendering.
-   : New backend for the map feature.
-   : New frontend for the map feature.
-   , , : Heavily modified to support new color logic and translations.
-   : Contains all new Arabic translations.
-   : Contains the new color palette for roles and statuses.
-   , : Modified to add routing and navigation for the new page.

**Areas that need refactoring**:
None.

**key api endpoints**
-   : Creates a leave request.
-   , : New CRUD endpoints for the map feature.

**Critical Info for New Agent**
-   The user has just provided a large list of new requirements. You MUST address these systematically. Start by creating a plan that covers the new items and get user approval.
-   **Priority Order:**
    1.  Fix the missing Mohammed (CEO) user account.
    2.  Implement the new, detailed transaction types.
    3.  Complete the Work Locations map feature.
    4.  Address the UI requests (Supervisor Assignment, Contract Deletion).
    5.  Improve PDF formatting.
-   The user is very specific about colors and UI behavior. Pay close attention to their feedback in Arabic.
-   The Work Locations feature is already started. Resume work from the existing files ( and ).

**documents and test reports created in this job**
-    (Updated)
-   Test reports from  were generated but are now outdated due to the new requirements.

**Last 10 User Messages and any pending HUMAN messages**
10. : Requests that status colors reflect the role of the current approver and provides detailed specs for the map feature. (Task in progress)
9. : Acknowledges the new color and map requirements and begins implementation.
8. : Implements the backend API for the map feature (Work Locations).
7. : Implements the frontend page for Work Locations and adds navigation.
6. : Reports that Arabic text is reversed in PDF and previews. (Task Received)
5. : Fixes the Arabic text rendering issue in .
4. : Tests the PDF fix and other functionality, confirms it works, and updates PRD.md.
3. ** (PENDING/CRITICAL):** Provides a large, new list of requirements: complete the map feature by linking it to employees, add numerous new specific transaction types, fix PDF formatting, add a supervisor assignment UI, add contract deletion for STAS, and points out the CEO Mohammed is missing from the UI.
2. : Acknowledges the large list of new requirements.
1. : Starts implementing the new requirements, beginning with the final color-coding fix.

**Project Health Check:**
-   **Broken:**
    -   The CEO role (Mohammed) is not accessible in the frontend, blocking a key part of the approval chain.
-   **Mocked:** None.

**3rd Party Integrations**
-    &  for OpenStreetMap integration.

**Testing status**
-   **Testing agent used after significant changes:** YES.
-   **Troubleshoot agent used after agent stuck in loop:** NO.
-   **Test files created:** None.
-   **Known regressions:** None currently, but the supervisor workflow bug was a recent regression that has been fixed.

**Credentials to test flow:**
Use the user-switcher dropdown in the app's header. No passwords required. Roles include , , , , , and . The  role is missing from the UI and needs to be added.

**What agent forgot to execute**
The agent was about to finish the job before receiving the user's final, large list of requirements. A key oversight from previous work is the absence of the Mohammed (CEO) user in the frontend user-switcher, which has now become a P0 issue.</analysis>
