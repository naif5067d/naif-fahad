<analysis>**original_problem_statement:**
The user wants to build DAR AL CODE HR OS, a mobile-first, enterprise-grade HR operating system for an engineering consultancy. The system must be built following strict guidelines inspired by NIST RBAC, WCAG 2.2, Event Sourcing, Apple HIG, Material Design, and OWASP.

**PRODUCT REQUIREMENTS (LOCKED):**

**Phase 1 (Initial Build - Completed):**
-   **Core Concept:** Every action is an immutable transaction recorded in append-only ledgers. Employee profiles are read-only aggregations.
-   **RBAC (NIST-style):**
    -   **Roles:** Employee, Supervisor, Sultan (Ops Admin), Naif (Ops/Strategic), Salah (Finance), Mohammed (CEO), STAS (System Executor).
    -   **Rules:** No self-signup. Only STAS manages users. Access is strictly role-based.
-   **Transactions & Workflow:**
    -   Each transaction has a unique , immutable timeline, approval chain, and status.
    -   **Workflow:** Created → Supervisor → Ops Admin → Finance → CEO → STAS Execute.
    -   Generates a hashed A4 PDF for every transaction.
-   **Append-only Ledgers:** Leave, Finance, Attendance, Warning, Asset.
-   **STAS Mirror:** A special view for the STAS role to verify transactions.
-   **UI/UX:** Apple-inspired clean design, mobile-first, responsive, with full Light/Dark modes and full Arabic RTL support.

**Phase 2 (Stabilization Patches - Completed, with a regression):**
1.  **Approval Routing Fix:** The workflow must correctly skip the supervisor step if the requester is the supervisor or has no supervisor. (REGRESSION DETECTED).
2.  **Full Language Switch:** UI must be 100% Arabic or 100% English. (DONE).
3.  **PDF Arabic Rendering:** PDFs must embed an Arabic font. (DONE).
4.  **Mobile Decision Bar:** Approve/Reject/Execute buttons must be in a sticky footer on mobile. (DONE).
5.  **Attendance Compliance:** Add a Work Location dropdown. (DONE).
6.  **Manual Holiday Calendar:** STAS must have a settings panel to manage holidays. (DONE).
7.  **STAS Maintenance Tools:** Add STAS-only functions to purge/archive data. (DONE).
8.  **Backend Behavior Lock:** Implemented strict server-side validation for workflows, leave rules, attendance, and contracts. (DONE).

**User's preferred language**: English and Arabic. The user provides technical requirements in English and UI feedback in Arabic. The next agent must respond in the user's chosen language for that message. Default to English for technical planning.

**what currently exists?**
A full-stack HR OS application built with React, FastAPI, and MongoDB. All core modules (Auth, RBAC, Transactions, Ledgers) are in place. Two major stabilization patches have been completed, implementing full localization, PDF rendering, mobile UI fixes, and strict backend validation for all business logic. A user-switcher in the header is used for role testing instead of a login page.

**Last working item**:
-   Last item agent was working: The user reported a critical regression in Arabic: when a supervisor submits a leave request, the request incorrectly gets stuck in the Pending Supervisor state, waiting for their own approval. The system correctly blocks the self-approval action, but the workflow doesn't advance automatically to the next stage ('Sultan'). The agent acknowledged the issue and was about to start fixing it.
-   Status: NOT STARTED
-   Agent Testing Done: N
-   Which testing method agent to use? backend testing agent
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1: Supervisor Self-Approval Workflow Bug (P0)**

**Issues Detail:**
-   **Issue 1: Supervisor Self-Approval Workflow Bug**
    -   **Attempted fixes:** This logic was part of the previous stabilization patches, but it is either incomplete or has regressed.
    -   **Next debug checklist:**
        1.  Examine the transaction creation logic in  and other transaction routes (e.g., ).
        2.  Focus on the part of the code where the initial transaction document is created. The bug likely lies here: the  is being incorrectly set to 'Pending Supervisor' by default, even when the requester is a supervisor.
        3.  Review the  function in . The check  should result in the transaction's initial status being set to 'Pending Ops' and the approver to 'Sultan'. Verify why this logic is failing.
        4.  Reproduce the issue by logging in as a  and creating a leave request. Verify via API that the transaction status is stuck.
        5.  Fix the logic to ensure the initial state is set correctly at creation time.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical workflow bug that prevents supervisors from using the system for their own requests, making the application untestable and unusable for that role.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None. This is the top priority blocker.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1: Implement Supervisor Assignment Feature:** The user requested a feature for 'Sultan' (Ops) and 'Naif' (Ops/Strategic) to assign/change an employee's supervisor via the employees list. This change should be a formal transaction requiring STAS approval.
-   **Future Tasks:**
    -   Full implementation of contract versioning and snapshots.
    -   Expand the Project location for attendance with geofencing and map integration.
    -   Build out the remaining ledgers (Warning, Asset) with corresponding transaction types.

**Completed work in this session**
-   **7-Point Stabilization Patch:**
    -   Implemented full UI localization (Arabic/English) and RTL support.
    -   Fixed Arabic PDF rendering by embedding a NotoSansArabic font.
    -   Added a sticky mobile decision bar for transaction approvals.
    -   Added a Work Location dropdown to the attendance page.
    -   Created a STAS-only settings panel for managing a manual holiday calendar.
    -   Added STAS maintenance tools for purging data and archiving users.
-   **Backend Behavior Lock Patch:**
    -   Created modular, server-side validation engines (, , ).
    -   Enforced strict, sequential approval workflows for all transactions.
    -   Implemented a pre-validation rule engine for leave requests (balance, overlap, holidays).
    -   Enforced server-side logic for attendance and settlement workflows based on employee contract status.
    -   Populated seed data with active contracts for all employees.
-   **Testing:** Performed extensive testing via curl, screenshots, and the .

**Earlier issues found/mentioned but not fixed**
-   The **Supervisor Self-Approval Workflow Bug** was thought to be fixed but was reported again by the user, indicating the fix was not robust.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** None.
-   **Recurrence count:** The supervisor workflow bug has now occurred twice in this job.
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Python, MongoDB (), 
-   **Frontend:** React.js, Tailwind CSS, shadcn/ui, 
-   **Authentication:** Custom JWT with Role-Based Access Control (RBAC).
-   **Architecture:** Modular backend with distinct engines for workflow logic, business rules, and validation.

**key DB schema**
-   : {username, email, role, hashed_password, disabled, is_archived}
-   : {user_id, name, supervisor_id, ...}
-   : {ref_no, type, created_by, status, approvers, workflow, ...}
-   , , 
-   : {employee_id, content, version, start_date, end_date, is_active}
-   : {date, description, type}

**changes in tech stack**
None.

**All files of reference**
-   : Contains the primary logic for creating leave requests and needs to be fixed.
-   : May have similar workflow creation logic that needs checking.
-   : Contains the core workflow state transition logic.
-   : Contains business rule validation (e.g., leave balance).
-   : The UI where the user observes the stuck transaction.
-   : The Product Requirements Document.

**Areas that need refactoring**:
None. The user has forbidden refactoring. The focus is on fixing the bug.

**key api endpoints**
-   : Creates a leave request. (BUG is here).
-   : Creates an expense request. (Potential BUG is here).
-   : Approves a transaction.
-   : Lists users for the user-switcher.
-   : Adds a manual holiday.

**Critical Info for New Agent**
-   **Immediate Priority is the Bug:** You must fix the supervisor self-approval workflow bug before anything else. The user is blocked. Do not work on any new features until this is resolved and confirmed by the user.
-   **Reproduce First:** Before writing code, switch to the  role and create a leave request to confirm you can reproduce the bug as described.
-   **User's Language:** The user reported the bug in Arabic. Be prepared to communicate the fix and ask for verification in Arabic if they continue in that language.
-   **New Feature Request:** Acknowledge the user's new feature request (assigning supervisors) but state that you will address it *after* the critical bug is fixed.

**documents and test reports created in this job**
-   
-    (Note: This is from the first stabilization patch and may not cover the latest backend changes).

**Last 10 User Messages and any pending HUMAN messages**
10. : Asks to test the settlement workflow. (Completed)
9. : Verifies PDF Arabic rendering is still working. (Completed)
8. : Runs linting. (Completed)
7. : Takes a screenshot to verify UI. (Completed)
6. : Updates PRD.md and prepares to finish. (Completed)
5. : Provides a new Backend Behavior Lock patch with 6 strict requirements, focusing on server-side validation and logic. (Task Received)
4. : Implements the entire backend behavior lock patch, adding validation modules and updating all relevant routes. (Completed)
3. : Performs extensive testing of the new backend logic, including re-seeding the database, and confirms all workflows are working as per the new rules. (Completed)
2. : Prepares to finish after completing the backend patch.
1.  ** (PENDING):** Reports a critical bug in Arabic. When a supervisor creates a request, it shows this message: You cannot approve your own transaction and the status gets stuck on Pending Supervisor, which is illogical! It should go directly to Sultan. Also requests a new feature to allow Sultan/Naif to assign supervisors.

**Project Health Check:**
-   **Broken:**
    -   The core transaction approval workflow is critically broken for the 'supervisor' role, preventing them from creating their own requests.
-   **Mocked:** None.

**3rd Party Integrations**
None.

**Testing status**
-   **Testing agent used after significant changes:** YES.
-   **Troubleshoot agent used after agent stuck in loop:** NO.
-   **Test files created:** None.
-   **Known regressions:** The supervisor self-approval workflow has regressed and is the highest priority issue.

**Credentials to test flow:**
Use the user-switcher dropdown in the app's header. No passwords required.
-   **To reproduce the bug:** Switch to the  user.
-   **To test the fix:** Use , , and  to test different workflow paths.

**What agent forgot to execute**
The agent did not create a specific test case for a user who is *also* a supervisor submitting a request for themselves. While the general logic for skip supervisor was implemented, this specific edge case was missed during testing, leading to the regression.</analysis>
