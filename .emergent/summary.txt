<analysis>**original_problem_statement:**
The user wants to build a complete Settlement (المخالصة) and final clearance module, deeply integrated with the existing contract and HR systems of DAR AL CODE HR OS. This is a major new feature set requested after the previous critical PDF bugs were fixed.

**PRODUCT REQUIREMENTS (Based on latest user requests):**

1.  **P0: Settlement Module:**
    *   Create a Settlement process initiated from the Contracts V2 page, accessible only to 'sultan' and 'STAS'.
    *   The process must be tied to an existing contract and support multiple termination types (end of contract, resignation, termination during probation, mutual agreement).
    *   **Bank Details (CRITICAL):** Add Bank Name and IBAN fields to the contract model and all UIs. These fields must be editable at any time and reflected in the final settlement.
    *   **Accurate Calculations (Backend):**
        *   : Must be calculated as  from the contract (Housing, Transport, etc.), not just the basic salary.
        *   : Calculated as . The leave balance must be calculated on a pro-rata basis ().
        *   : Calculated based on Saudi Labor Law, factoring in years of service and reason for termination (resignation vs. termination).
    *   **Settlement PDF:**
        *   Generate a single-page, A4, hybrid Arabic/English formal document.
        *   Must include company letterhead, transaction number, employee and contract details.
        *   Crucially, it must feature a **Barcode** (not a QR code) for STAS execution, and spaces for signatures.
    *   **Workflow:**
        *   Admin previews all calculations.
        *   STAS gives final, one-time execution.
        *   After execution, the employee's contract is marked Terminated, all balances are frozen, and their account is locked, showing a message to contact HR.

2.  **P1: Attendance & Payroll Enhancements:**
    *   **Deductions & Bonuses:** Create a UI for 'sultan' to add deductions or bonuses for any employee. These require STAS approval and must be automatically included in the settlement calculation.
    *   **Attendance System:** Implement a comprehensive daily attendance view (Present, Absent, On Leave, Permission) that admins can edit.
    *   **Employee Card:** Activate the Employee Card in the profile to show a live summary: daily status, leave balances, and monthly hour balance.
    *   **Leave Notifications:** Implement a system to notify admins ('sultan', 'NQ', 'STAS') three months before a contract ends if the employee has a remaining leave balance.

**User's preferred language**: Arabic. The next agent **MUST** respond and interact in Arabic.

**what currently exists?**
The previous agent achieved a major breakthrough by fixing the critical PDF generation bugs. The core Arabic text rendering issue (appearing as squares or garbled) and the blank English PDF regression have been **resolved**. This was done by completely refactoring  to use separate  Paragraph styles for RTL (Arabic text with ) and LTR (English/numbers with ). The fix was validated by the testing agent.

Following the fix, the agent received the new, large feature request for the Settlement module. The agent has laid the groundwork by creating the necessary placeholder files:
*   Backend: , , , .
*   Frontend: , .

**Last working item**:
-   **Last item agent was working:** The agent was scaffolding the new modules required for the settlement feature. The final action was creating the placeholder file . The foundation is laid, but no business logic has been implemented yet.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both. The backend testing agent will be crucial for verifying the complex financial calculations in  and the end-to-end settlement API flow. The frontend testing agent will be needed to test the new  and  UIs.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
There are no outstanding *bugs*. The focus has shifted entirely to new feature development. The pending work is the implementation of the user's large request, which is broken down into tasks below.

**In progress Task List**:
-   **Task 1: Build the Settlement, Attendance, and HR Calculation Module (P0)**
    -   **Where to resume:** Begin by implementing the first and most critical user requirement: adding the 'Bank Name' and 'IBAN' fields.
        1.  Modify the contract model in .
        2.  Update the contract creation/editing API routes in .
        3.  Update the contract creation/editing form in .
    -   **What will be achieved with this?** This will complete the foundational data model changes required before starting the settlement calculations.
    -   **Status:** NOT STARTED
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0:** Implement Core Settlement Backend Logic:
        *   In , implement the functions for , End of Service (EOS), and Leave Encashment based on the user's exact formulas.
        *   In  and , build the API to create, preview, calculate, and execute a settlement, pulling data from the contract and .
    -   **P1:** Implement Settlement and Payroll UI:
        *   Develop the  to guide the admin through the settlement process.
        *   Develop the  component and integrate it into the employee list/profile.
        *   Implement the new editable attendance grid as requested.
    -   **P1:** Implement Settlement PDF Generation:
        *   Create a new PDF generation function for the settlement document, ensuring it is a hybrid Arabic/English A4 page with a **Barcode** for STAS.
    -   **P2:** Implement Finalization Logic:
        *   Add the logic to lock the employee account and update the contract status to 'Terminated' after settlement execution.
        *   Implement the notification system for expiring contracts with remaining leave.

-   **Future Tasks:**
    -   CEO Dashboard & enhanced Employee Profile Card.
    -   Warnings & Loans Modules.

**Completed work in this session**
-   **Fixed Critical PDF Generation (P0):** Completely rewrote  to correctly render Arabic text using  and , fixing the squares bug. The fix also resolved issues with numbers, dates (), and reference numbers () appearing incorrectly.
-   **Fixed Blank English PDF Regression:** Ensured the English version of the PDF generates correctly by using separate LTR text styles.
-   **Validated Fixes with Testing Agent:** Successfully ran the testing agent (), which confirmed all PDF-related fixes worked as expected for both Arabic and English.
-   **Created Skeleton for Settlement Module:** Created placeholder files for the new settlement, service calculator, and deduction/bonus features to prepare for the next phase of development.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Lax GPS Validation:** The backend still accepts check-in/out records even if the  flag is . This was not part of the current scope.
-   **Issue 2: Global-Only Ramadan Hours:** The system lacks support for per-location or per-project Ramadan hours.

**Known issue recurrence from previous fork**
-   **Issue:** Broken Arabic rendering in PDFs.
-   **Recurrence count:** High.
-   **Status:** **RESOLVED**. The agent successfully implemented a robust solution using  Paragraph styles, which was verified by the testing agent. This major blocker is now closed.

**Code Architecture**


**Key Technical Concepts**
-   **ReportLab RTL/LTR Styling:** The key to the PDF fix was using separate  objects within . One for Arabic (, Arabic font) and one for English/numbers (, LTR font like ).
-   **HR Financial Calculations:** The upcoming work will involve implementing precise financial formulas for End of Service awards and Pro-rata leave accrual as specified by the user.

**key DB schema**
-   ****: Will be updated to include  and .
-   **** (New Collection): Will store the details of each final settlement transaction, including all calculated values, status (, ), and a reference to the contract and employee.

**All files of reference**
-   **Fixed PDF utility:** 
-   **New Settlement Model:** 
-   **New Settlement Service:** 
-   **New Calculation Service:** 
-   **New Settlement Route:** 
-   **New Settlement UI:** 
-   **Contract Model (to be modified):** 
-   **Contract UI (to be modified):** 

**Critical Info for New Agent**
-   **Your main goal is to build the entire Settlement and HR calculation module.** The user has provided extremely detailed requirements. Follow them precisely. The previous critical issue (PDFs) is now solved.
-   **Start with the Bank/IBAN fields.** This is a mandatory first step requested by the user and is a prerequisite for the rest of the settlement feature.
-   **All communication with the user must be in Arabic.**
-   The user is highly detail-oriented. The financial calculations must be implemented exactly according to the formulas they provided.
-   Refer to the user's last two long messages (Chat Messages 210 & 217) as the primary Product Requirements Document for this phase.

**documents and test reports created in this job**
-    (Shows successful test run for the PDF fix)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Provided a comprehensive and detailed specification for the Settlement module, including payroll calculations (Last Wage, EOS, Leave), workflow (Admin preview, STAS execution), PDF requirements (hybrid, barcode), and a critical last-minute addition of **Bank Name and IBAN** fields to the contract.
2.  **User:** Provided the initial high-level requirements for the next phase, covering Settlement, Attendance system overhaul, Employee Card activation, and the STAS logic. Demanded a technical report of changes, not screenshots.

**Project Health Check:**
- The project is now stable. The primary Broken component (PDF Generation) has been fixed and verified. The focus is now on major feature development.

**3rd Party Integrations**
-   
-   
-   
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES, successfully used to verify the PDF generation fix.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None persistent. Temporary test files were created and deleted.
-   **Known regressions:** None. The previous English PDF regression was fixed.

**Credentials to test flow:**
-   Use the user-switcher dropdown in the app's header. Roles include , , , and various employees. No passwords are required.

**What agent forgot to execute**
-   The agent has correctly transitioned from fixing bugs to planning the next major feature. Nothing was forgotten; the next step is to begin the implementation of the large settlement module as per the new user requirements, starting with the Bank and IBAN fields.</analysis>
