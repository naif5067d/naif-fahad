<analysis>**original_problem_statement:**
The user is building a comprehensive, mobile-first HR operating system named DAR AL CODE HR OS. The primary goal is to refine the existing application based on a continuous stream of detailed feedback and then move on to larger features.

The user's immediate and high-priority requests include:
1.  **Bug Fix (P0):** Fix a critical UI bug where multiple maps are overlapping on the Add/Edit Work Location page, making it unusable.
2.  **UI/UX Enhancement (P0):** Overhaul the leave request calendar UI. It must be color-coded to disable and visually distinguish weekends (black), official holidays (brown), and days with existing conflicting leave requests (red).
3.  **STAS Mirror Enhancement (P1):** The STAS Mirror page should act as a detector, explicitly stating the reasons for potential conflicts (e.g., Request conflicts with official holiday, User has a pending request of the same type).
4.  **PDF Generation Refinements:** The STAS execution seal in PDFs needs to be a proper, scannable barcode with a perforated cut-out section at the bottom of the page. The name of the approver must appear in Arabic.
5.  **Data & Logic Integrity:**
    *   Remove all hardcoded English strings; the application must be 100% Arabic when the Arabic language is selected.
    *   Reset all leave balances to the standard 21/30 days.
    *   Delete all existing test transactions.
    *   Ensure deleting transactions does not affect employee work location data.
6.  **New Features:**
    *   Implement a system-wide notification/announcement system manageable by the admin (STAS), with support for pinned messages.
    *   Add an app version number to the UI.
    *   Allow creating a new employee directly from the Create Contract V2 form.
    *   Require a PDF file upload for sick leave requests.
    *   Implement a permission system for granting personal leave hours (2 hours by default, with admin override up to 3).

**User's preferred language**: Arabic. The next agent **MUST** respond and interact in Arabic.

**what currently exists?**
The agent has implemented several features and fixes based on user requests. A system-wide notification system has been created with both backend APIs and a frontend management UI in the System Maintenance page. The STAS PDF seal was updated to use a barcode (though further refinement is needed), and the approver's name is now shown in Arabic. The contract creation form was enhanced to support creating a new employee directly. Logic for requiring a file upload for sick leave has been added. The STAS status labels and colors in the UI were updated to be more descriptive and less personalized. The legacy Contracts V1 pages have been removed from the UI.

**Last working item**:
-   **Last item agent was working:** The agent was tasked with fixing a critical UI bug where multiple, overlapping maps were rendering on the work location creation/editing page. The user provided a screenshot confirming the issue. The agent acknowledged the problem and was about to start debugging it.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Frontend testing agent or screenshot tool to verify the map UI fix.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   Issue 1: Multiple overlapping maps render on the work location page (P0)
-   Issue 2: Leave request calendar lacks color-coding for unavailable days (P0)
-   Issue 3: PDF barcode seal needs a perforated cut-out section (P1)
-   Issue 4: UI still contains some hardcoded English text (P2)
-   Issue 5: Incomplete Admin Attendance Data (on_leave, is_late are always '0') (P2)

**Issues Detail:**
-   **Issue 1: Multiple overlapping maps render on the work location page (P0)**
    -   **Attempted fixes:** None yet. Agent just acknowledged the issue.
    -   **Next debug checklist:**
        1.  Examine .
        2.  Investigate the component rendering logic. The issue is likely caused by a  being rendered multiple times within a loop or due to state updates causing re-renders without proper cleanup.
        3.  Ensure that only one  is active at any time, especially within the Add New or Edit modals/dialogs.
        4.  Check for CSS conflicts that might be causing visibility issues.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical, blocking bug that makes the work location management feature unusable. Fixing it will restore core functionality.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** No.

-   **Issue 2: Leave request calendar lacks color-coding for unavailable days (P0)**
    -   **Next debug checklist:**
        1.  Modify .
        2.  Use the  and  props of the  component (used by Shadcn's Calendar).
        3.  Fetch official holidays and the user's existing leave requests.
        4.  Implement a function that returns  for disabled days (weekends, holidays, existing leave).
        5.  Implement a function that returns a style object for different day types: weekend (black background), holiday (brown background), conflict (red background).
    -   **Why fix this issue and what will be achieved with the fix?** It provides a much better user experience, preventing users from making invalid leave requests and giving them immediate visual feedback.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** No.

-   **Issue 3: PDF barcode seal needs a perforated cut-out section (P1)**
    -   **Attempted fixes:** The agent created a barcode but did not add the requested cut-out section.
    -   **Next debug checklist:**
        1.  Edit .
        2.  In the function that draws the PDF footer ( or similar), add logic to draw a second, identical barcode at the very bottom of the page.
        3.  Draw a dashed or dotted line () above this second barcode to signify a cut here line.
    -   **Why fix this issue and what will be achieved with the fix?** Fulfills a specific user requirement for physical record-keeping.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend (by downloading and inspecting the PDF).
    -   **Blocked on other issue:** No.

**In progress Task List**:
-   **Task 1: Build advanced leave calendar UI (P0)**
    -   **Where to resume:** .
    -   **What will be achieved with this?** A user-friendly, intuitive calendar for requesting leave that prevents errors.
    -   **Status:** NOT STARTED
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on something:** No.

-   **Task 2: Implement STAS Mirror Detector (P1)**
    -   **Where to resume:**  and relevant backend endpoints.
    -   **What will be achieved with this?** Admins (STAS) will see clear, actionable reasons for transaction conflicts, improving their decision-making process.
    -   **Status:** NOT STARTED
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on something:** No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1:** Create a UI for the  endpoint in the System Maintenance page to allow admins to reset all leave data.
    -   **P1:** Employee Migration to V2 contracts (with opening data snapshot).
    -   **P2:** Implement the full Settlement Module.
-   **Future Tasks:**
    -   **P2:** CEO Dashboard & enhanced Employee Profile Card.
    -   **P3:** Warnings & Loans Modules.

**Completed work in this session**
-   **Notification System:** Created backend () and frontend UI for admins to send and manage system-wide announcements.
-   **Contract Management V2:** Enhanced the creation form to allow creating a new employee profile simultaneously with the contract.
-   **Leave Management:**
    -   Added a file upload requirement for sick leave requests.
    -   Removed hardcoded 25 days leave option.
-   **STAS & PDF:**
    -   Replaced QR code with a barcode in the PDF seal.
    -   Ensured the approver's name appears in Arabic in the PDF.
    -   Removed personalized Waiting for STAS labels in favor of Waiting for Execution.
-   **UI/UX:**
    -   Added a Get My Location button to the work location map.
    -   Added the app version number to the footer.
    -   Removed the legacy Contracts V1 link from the sidebar.
    -   Fixed numerous hardcoded English strings in the UI and error messages.
-   **Backend Admin:** Created an endpoint to reset leave balances and delete all transactions.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Incomplete Admin Attendance Data:** The  endpoint does not calculate  and  fields.
-   **Issue 2: Global-Only Ramadan Hours:** The system lacks support for per-location or per-project Ramadan hours.
-   **Issue 3: Lax GPS Validation:** The backend accepts check-in/out records even if the  flag is .
-   **Issue 4: Unsynced Leave Balance:** The leave entitlement from contracts may not automatically synchronize as a credit into the , requiring manual intervention.

**Known issue recurrence from previous fork**
-   **Issue:** Hardcoded English text appearing in the UI despite efforts to achieve full translation.
-   **Recurrence count:** High. The user frequently points out untranslated labels and messages.
-   **Status:** IN PROGRESS. This requires ongoing vigilance.

**Code Architecture**


**Key Technical Concepts**
-   **PDF Generation:**  for drawing PDFs, including barcodes and text.
-   **Interactive Maps:**  for displaying work locations.
-   **File Uploads:** FastAPI's  for handling file submissions.
-   **Internationalization (i18n):**  for English/Arabic translations.
-   **State Management:** React hooks (, ) for managing component state.

**key DB schema**
-   ****: 
-   ****: The  field was added to leave requests.

**changes in tech stack**
-   None.

**All files of reference**
-   **Overlapping Map Bug:** 
-   **Leave Calendar UI:** 
-   **PDF Barcode:** 
-   **Notification System:** , 
-   **Contract Creation:** , 
-   **Translations:** , 

**Areas that need refactoring**:
-   **:** The component's rendering logic needs to be fixed to prevent the overlapping maps bug.
-   **:** Will require significant changes to implement the new color-coded calendar logic.

**key api endpoints**
-   : Create a new announcement.
-   : Get all announcements.
-   : Upload a medical report for a leave request.
-   : Admin endpoint to clean up data.

**Critical Info for New Agent**
-   **TOP PRIORITY:** You must immediately fix the overlapping maps bug on the . The user is blocked by this.
-   **USER INTERACTION:** The user is highly detail-oriented and will provide frequent, specific feedback. Always confirm your understanding of their requests before implementing. All communication must be in Arabic.
-   **PROOF OF WORK:** The user expects to see evidence of your changes. Use screenshots and clear descriptions of what was done.
-   **LANGUAGE:** Be extremely diligent about translations. Check all new UI elements and messages to ensure they are added to both  and  files.

**documents and test reports created in this job**
-   /app/memory/PRD.md (updated multiple times)
-   /app/test_reports/iteration_1.json
-   /app/test_reports/iteration_2.json
-   /app/test_reports/iteration_3.json

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST/PENDING):** Provided a screenshot showing 3 overlapping maps on the Add Work Location page and stated this is an annoying bug that needs to be fixed immediately.
2.  **Agent:** Acknowledged the creation of the notification UI.
3.  **User:** Asked where to write notifications and requested work on specific Next Action Items, including the STAS mirror and the balance reset endpoint.
4.  **Agent:** Explained the notification UI wasn't built yet and that they would add it.
5.  **User:** Asked for the location to write notifications.
6.  **Agent:** Summarized the successful test run and prepared to update PRD.md.
7.  **User:** Outlined a long list of new requirements: fix overlapping maps, add a my location button, improve the leave calendar with color-coding, improve error messages (make them bilingual), reset all leave balances, add a version number, and implement a pinnable announcement system.
8.  **Agent:** Finished the previous task and updated PRD.md.
9.  **User:** Requested the removal of old contract management pages and outlined major enhancements for the V2 contract creation form (support new employees), leave management (require PDF for sick leave), and permissions for personal leave hours. Demanded full Arabic translations.
10. **Agent:** Presented a summary of completed work and the plan for the next steps.

**Project Health Check:**
-   **Broken**: The Work Location creation/editing feature is broken due to the overlapping maps bug.
-   **Mocked**: N/A

**3rd Party Integrations**
-   

**Testing status**
-   **Testing agent used after significant changes:** YES, the agent used the testing agent multiple times to verify functionality after major changes.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** The implementation of the map feature on the work locations page introduced a major UI bug (overlapping maps).

**Credentials to test flow:**
-   Use the user-switcher dropdown in the app's header. Roles include , , , and  (CEO). No passwords are required.

**What agent forgot to execute**
-   The agent did not implement the color-coded leave calendar as requested.
-   The agent did not implement the detector logic for the STAS mirror to explain conflicts.
-   The agent introduced a critical bug (overlapping maps) while implementing another feature.</analysis>
