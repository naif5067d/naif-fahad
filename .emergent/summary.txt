<analysis>**original_problem_statement:**
The user wants to build a complete Settlement (المخالصة) and final clearance module, deeply integrated with the existing contract and HR systems of DAR AL CODE HR OS. The scope has expanded to include a robust, rule-based daily attendance and deduction system, and significant UI/UX enhancements to the employee profile and dashboard.

**PRODUCT REQUIREMENTS (Based on latest user requests):**

1.  **P0: Daily Attendance & Deduction Engine:**
    *   **Daily Status Resolver:** Implement a backend engine that determines a single, final daily status for each employee (, , , , , etc.) based on a strict, user-approved order of operations (Holidays > Leave > Missions > Attendance, etc.). This result must be stored in a new  collection.
    *   **Monthly Hours Summary:** Create a monthly process to calculate required vs. actual work hours, deficits, and compensated overtime for each employee, storing the results in a new  collection.
    *   **Deductions Workflow:** Implement a non-direct deduction system. Attendance violations (absence, lateness) should generate a Deduction Proposal in a new  collection. This proposal must be reviewed by 'sultan' and can only be executed by 'stas' to be written to the financial ledger.

2.  **P0: Employee Dashboard Personalization:**
    *   Display the Employee Card prominently on the employee's own dashboard () to provide a personalized welcome and summary.
    *   Ensure the option to change an employee's profile picture is only available to 'stas' from the employee's profile page.

3.  **P1: Leave & Contract Management Enhancements:**
    *   Implement a system for notifying management about contracts expiring within 3 months.
    *   Provide a mechanism for 'sultan', 'naif', and 'stas' to carry over unused leave balances.

**User's preferred language**: Arabic. The next agent **MUST** respond and interact in Arabic.

**what currently exists?**
The agent has successfully implemented several major features. The Settlement PDF generation is complete and verified, with the company logo and correct legal text. A full employee profile page and a preview card have been created. A notification system for expiring contracts (bell icon, dashboard alerts, flashing rows) is active. The Work Locations module was enhanced with a modern UI for setting separate check-in/out grace periods. The Finance page was removed as requested. Most critically, the agent engaged in a deep, multi-step dialogue with the user to define and get approval for the precise logic of a new **Daily Attendance Resolver**, which is the next major piece of work.

**Last working item**:
-   **Last item agent was working:** The agent was beginning to implement the user's latest request: to display the employee's information card directly on their own dashboard for a more personalized experience, and to ensure only 'stas' can edit profile pictures. The agent had started exploring the relevant frontend files (, ).
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** screenshot tool. The agent should take a screenshot after logging in as a regular employee to verify the card appears correctly on their dashboard. Then, log in as 'stas' to confirm the edit picture option is visible on an employee's profile, and as a regular employee to confirm it's hidden.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Implement Employee Card on Employee's Own Dashboard (P0)**

**Issues Detail:**
-   **Issue 1: Implement Employee Card on Employee's Own Dashboard**
    -   **Attempted fixes:** The agent has viewed  to understand its structure.
    -   **Next debug checklist:**
        1.  Modify .
        2.  Fetch the current user's data (likely available in a context or from ).
        3.  Conditionally render a component similar to the  if the user's role is 'employee'.
        4.  Style it elegantly as requested by the user.
        5.  On the , ensure the change picture functionality is visible only to the 'stas' user.
    -   **Why fix this issue and what will be achieved with the fix?** It will fulfill the user's direct request for a more personalized and engaging employee experience on the main dashboard.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   None apart from the issue listed above.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Build the Daily Attendance Resolver, Monthly Hours, and Deductions Workflow:** This is the highest priority major task. The logic is fully defined and approved.
        -   **Phase 1: Database and Models:** Create the three new backend models and MongoDB collections: , , and .
        -   **Phase 2: The Resolver Engine:** In the backend, build the  function that follows the user-approved 10-step logic to determine and save the  in the  collection. This should run as a scheduled task at the end of each day.
        -   **Phase 3: The Deduction Workflow:** Build the backend logic and APIs for the  workflow: automated proposal creation, a UI for Sultan to review/approve, and a final execution endpoint for STAS.

-   **Future Tasks:**
    -   CEO Dashboard
    -   Warnings Module
    -   Loans Module

**Completed work in this session**
-   **Settlement PDF Fixed:** Successfully added the company logo from database settings and corrected the legal acknowledgment text. Verified with PDF analysis.
-   **Employee Profile Feature:** Implemented a full employee profile page () and a preview card modal.
-   **Expiring Contract Notifications:** Added a bell icon with a notification dropdown in the header, a dedicated section on the dashboard, and made employee rows flash red in the employee list.
-   **Leave Carry-Over:** Added a Carry Over button on the employee profile's leave balance section.
-   **Work Location Grace Period:** Added separate, modern slider controls for setting check-in and check-out grace periods.
-   **Finance Page Removal:** Completely removed the Finance ($ icon) page from the frontend (navigation, routing) and backend (routes).
-   **Defined Core HR Logic:** Completed an extensive analysis and clarification process with the user to define and get approval for the entire Daily Attendance Resolver and Deduction Workflow logic.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Lax GPS Validation:** The backend accepts check-in/out records even if the  flag is . The new resolver should factor this in.
-   **Issue 2: Global-Only Ramadan Hours:** The system lacks support for per-location or per-project Ramadan hours. The logic for  calculation in the new resolver accounts for this.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **State Machine Logic:** The approved design for the  is a classic state machine that processes rules in a strict priority order to arrive at a definitive state.
-   **Asynchronous Workflows:** The Deduction Proposal system is an asynchronous workflow involving multiple user roles (System -> Sultan -> STAS).
-   **Component-Based UI:** Extensive use of React components (Cards, Sliders, Modals) from Shadcn UI to build new features.
-   **Conditional Rendering:** UI elements (notifications, buttons, edit access) are conditionally rendered based on user role and data state.

**key DB schema**
-   ****: Modified to add  and .
-   ****: The agent has analyzed this collection and identified that it's being used for multiple purposes. The new  collection will separate deduction logic from it.
-   ****: The  document within this collection was used to retrieve the .
-   **UPCOMING COLLECTIONS (TO BE CREATED):**
    -   : 
    -   : 
    -   : 

**All files of reference**
-   **To Modify Next:**
    -    (Add employee card)
    -    (Restrict picture editing to STAS)
-   **For Upcoming Major Task:**
    -    (Contains the foundational logic to be expanded into the new resolver).
    -   Create new files for the models (, etc.) and the services/routes for the new resolver and deduction workflow.

**Critical Info for New Agent**
-   Your immediate task is to implement the user's request for a personalized employee dashboard card.
-   After that, your primary mission is to build the **Daily Attendance Resolver, Monthly Hours, and Deductions Workflow**. The logic for this has been meticulously defined and approved by the user in messages 280-292. **You must follow this approved logic precisely.** Do not improvise. The user expects the three new collections (, , ) and the specific workflows discussed.
-   The user is technical and appreciates clear, logical explanations. When building the resolver, it's wise to plan the implementation in phases (DB models, then the resolver, then the deduction workflow) and communicate this plan.
-   All communication must remain in **Arabic**.

**documents and test reports created in this job**
-    (Covers Profile Page, Notifications)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Requested to show the employee card on the employee's own dashboard and to restrict profile picture changes to 'stas'.
2.  **Agent:** Acknowledged and prepared to begin testing the 5 critical attendance logic cases.
3.  **User:** Provided the 5 critical test cases to verify the attendance logic before implementation.
4.  **Agent:** Answered the user's 8 final, specific questions about the proposed attendance resolver logic, confirming details about work schedules, grace periods, and the lock mechanism.
5.  **User:** Asked 8 highly specific follow-up questions to confirm the agent's understanding of the HR logic (e.g., When exactly does a Day Record get generated?).
6.  **Agent:** Provided a detailed, step-by-step logical explanation of the proposed Daily Attendance Resolver without writing any code, covering the decision hierarchy, record creation timing, and the deduction workflow.
7.  **User:** Asked the agent to explain the proposed attendance resolver logic in plain language (not code) to ensure full understanding before implementation.
8.  **Agent:** Provided a comprehensive and honest report on the current system's capabilities and shortcomings across 8 key HR logic areas, and proposed the three new collections (, , ) as the solution.
9.  **User:** Sent a detailed list of 8 critical questions to probe the system's current HR logic (e.g., How do you prove the daily status engine exists?).
10. **Agent:** Confirmed that the Finance page with the dollar sign icon was successfully removed, and the Financial Custody with the wallet icon remains.

**Project Health Check:**
-   **Broken:** Nothing is critically broken.
-   **Mocked:** The current attendance system's logic is incomplete and does not meet the user's requirements for fairness and accuracy. The Daily Attendance Resolver is designed to fix this but is not yet implemented.

**3rd Party Integrations**
-   
-   
-   
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES. Used to validate the Employee Profile and Notifications features.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   Use the user-switcher dropdown in the app's header to switch between roles like , , and . No passwords are required.

**What agent forgot to execute**
-   The agent has been diligent in following user requests. No tasks have been forgotten. The complex attendance logic was correctly identified as a major task requiring detailed planning and user approval before implementation, which has now been secured.</analysis>
