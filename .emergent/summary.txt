<analysis>**original_problem_statement:**
The user is building a comprehensive, mobile-first HR operating system named DAR AL CODE HR OS. The primary goal is to refine the existing application based on a continuous stream of detailed feedback.

The most critical user requests are:
1.  **P0 PDF & Arabic Language Bugs:** The user is extremely frustrated with multiple UI and document rendering issues. Arabic text appears as squares or is garbled/reversed in generated PDFs. The STAS execution seal (barcode) is also missing or incorrect. The English version of the PDF is now appearing blank, which is a new regression. Date formats are incorrect (e.g.,  instead of ).
2.  **P0 Business Logic & User Consent:**
    *   The attendance system must check if an employee is on approved leave before marking them absent. (This was fixed).
    *   For sick leaves that incur a salary deduction (days 31-120), the employee must be shown a formal warning and must sign to approve the deduction. This signature should appear as a blue QR code in the final PDF.
3.  **P1 HR Policy Implementation & UI:**
    *   Implement the full Saudi labor law sick leave policy (30 days full pay, 60 half pay, 30 no pay). The system should not block requests before 120 days but must get employee consent for deductions.
    *   The STAS Mirror UI must show an employee's sick leave consumption status (how many days used, which pay bracket they are in).
    *   Admins (specifically 'sultan') must be notified when an employee enters a new sick leave deduction bracket.
    *   Allow specific admins to edit **active** contracts via a comprehensive form.
    *   The attached medical report for a leave request must be visible to the admin, ideally as an inline preview.

**User's preferred language**: Arabic. The next agent **MUST** respond and interact in Arabic.

**what currently exists?**
The agent has implemented several key backend logic changes. The critical flaw where the attendance system marked employees on leave as absent has been fixed in . The backend logic for the 30/60/30 sick leave policy has been added to , along with an API () to check an employee's status. Functionality for uploading medical reports, adding cancellation comments by STAS, and fixing leave conflict checks to ignore cancelled transactions has also been completed.

On the frontend, dialogs have been added to warn employees about sick leave deductions, allow medical file uploads, and enable admins to enter cancellation reasons.

However, the main P0 issue of PDF generation remains critically broken. After failed attempts with , , and , the agent decided on a new strategy: rendering Arabic text to an image using  and embedding it into the PDF.

**Last working item**:
-   **Last item agent was working:** The agent was attempting to provide a guaranteed fix for the P0 Arabic text rendering issue in PDFs, which shows garbled text and squares. After failing with other libraries due to system dependencies, the agent started implementing a workaround. The plan is to use the  library to render Arabic text into an image and then embed that image into the PDF generated by .
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Backend testing. The agent should create a test route or use an existing one to generate a PDF containing Arabic text. Then, use the  tool on the resulting PDF file to visually verify that the text renders correctly and is no longer squares.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   Issue 1: PDF Generation is Critically Broken (P0)
-   Issue 2: Missing Employee Consent Signature for Salary Deductions in PDF (P0)
-   Issue 3: STAS Mirror UI doesn't show full sick leave consumption details (P1)
-   Issue 4: Admin notifications for sick leave status changes are not implemented (P1)
-   Issue 5: Date formatting is inconsistent across the application (P1)

**Issues Detail:**
-   **Issue 1: PDF Generation is Critically Broken (P0)**
    -   **Attempted fixes:**  direct text rendering failed.  and  failed due to missing OS-level dependencies in the environment.
    -   **Next debug checklist:**
        1.  Open .
        2.  Implement the logic to take an Arabic string, use  (PIL) with an appropriate Arabic font () to draw the text onto an in-memory image.
        3.  Save the image to a memory buffer (e.g., ).
        4.  In the  canvas, instead of using  or , use  to place the generated text image onto the PDF.
        5.  Test this approach on all dynamic Arabic fields: employee name, leave type, reason, and approval details.
        6.  Also investigate and fix the regression where the English version of the PDF is now blank.
    -   **Why fix this issue and what will be achieved with the fix?** This is the user's biggest point of frustration and makes a core feature of the application unusable. A fix is required to restore trust and basic functionality.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** No.

-   **Issue 2: Missing Employee Consent Signature for Salary Deductions in PDF (P0)**
    -   **Attempted fixes:** A frontend dialog was created to get consent, but this consent is not visually represented in the PDF as requested.
    -   **Next debug checklist:**
        1.  In , when a leave request has .
        2.  Generate a unique **blue** QR code.
        3.  Add a new section to the PDF template titled موافقة الموظف على الخصم (Employee Consent for Deduction).
        4.  In this section, draw the blue QR code and accompanying text confirming the employee's agreement to the deduction as per Article 117.
    -   **Why fix this issue and what will be achieved with the fix?** This is a legal and procedural requirement from the user to formalize the deduction process.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** Issue 1 (PDF Generation).

-   **Issue 3: STAS Mirror UI doesn't show full sick leave consumption details (P1)**
    -   **Attempted fixes:** A backend endpoint () was created. Some UI elements were added.
    -   **Next debug checklist:**
        1.  In , when a sick leave transaction is selected.
        2.  Call the  endpoint with the employee ID and dates.
        3.  Display the returned information clearly: Total sick days taken in the year, and which pay bracket the current request falls into (100%, 50%, or 0%).
    -   **Why fix this issue and what will be achieved with the fix?** It gives administrators the necessary context to approve or deny sick leave requests accurately.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** No.

**In progress Task List**:
-   **Task 1: Overhaul PDF Generation with Image-Based Rendering (P0)**
    -   **Where to resume:** .
    -   **What will be achieved with this?** A reliable and working PDF generation system that correctly displays Arabic text, fixing the most critical bug in the application.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on something:** No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1:** Implement admin notifications (for user 'sultan') when an employee enters a new sick leave pay bracket. This requires creating a notification service in the backend.
    -   **P1:** Implement a comprehensive fix for date formatting () everywhere it is displayed raw.
    -   **P1:** Create a system-wide notification to alert admins (, , ) when an employee has remaining leave and their contract is ending within 3 months.
    -   **P2:** Create a UI in the System Maintenance page for the  endpoint.
-   **Future Tasks:**
    -   **P2:** Employee Migration to V2 contracts.
    -   **P2:** Settlement Module.
    -   **P3:** CEO Dashboard & enhanced Employee Profile Card.
    -   **P3:** Warnings & Loans Modules.

**Completed work in this session**
-   **Fixed Critical Attendance Logic:** Implemented checks in  to verify leave/permission status before marking an employee as absent.
-   **Implemented Backend Sick Leave Policy:** Added the 30/60/30 day rule calculation to .
-   **Enabled PDF Upload for Sick Leaves:** Added frontend UI and a backend endpoint for employees to upload medical reports.
-   **Fixed Leave Date Conflict Logic:** Updated  to ignore 'cancelled' requests when checking for overlapping dates.
-   **Enabled Transaction Cancellation with Comments:** Admins using the STAS mirror can now cancel a transaction and are required to provide a reason.
-   **Made Contract Editing Form Comprehensive:** The modal for editing active contracts in  now shows the full contract details.
-   **Fixed File Authentication Issue:** The endpoint for serving uploaded files was made public to prevent Not authenticated errors when opening in a new tab.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Blank English PDF:** A major regression where the English version of the PDF is generated mostly empty. This needs to be investigated alongside the Arabic fix.
-   **Issue 2: Missing STAS QR Seal in PDF:** The user reported the QR code for the STAS execution step is not appearing in the approvals table.
-   **Issue 3: Lax GPS Validation:** The backend still accepts check-in/out records even if the  flag is .
-   **Issue 4: Global-Only Ramadan Hours:** The system lacks support for per-location or per-project Ramadan hours.

**Known issue recurrence from previous fork**
-   **Issue:** Broken Arabic rendering in PDFs.
-   **Recurrence count:** High. This has been the primary blocker and source of user frustration across multiple sessions.
-   **Status:** IN PROGRESS. The new text-to-image strategy is the latest attempt at a permanent solution.

**Code Architecture**


**Key Technical Concepts**
-   **PDF Generation Workaround:** The core technical challenge is bypassing 's poor support for right-to-left languages. The proposed solution is to render Arabic text to an image using  and then embed that image into the PDF.
-   **Business Logic Encapsulation:** Complex HR rules (attendance, sick leave) are correctly being managed in dedicated backend services (, ).
-   **File Handling:** Storing uploaded files in a persistent  directory and serving them via a dedicated public endpoint.

**key DB schema**
-   ****: The  field now stores a  for sick leaves. The main document now stores a  and has an updated status on rejection.

**All files of reference**
-   **New PDF Implementation:** 
-   **Current Broken PDF:** 
-   **Sick Leave Logic:** , 
-   **Attendance Logic:** 
-   **Leave Request UI:** 
-   **Admin UI:** , 

**Critical Info for New Agent**
-   **ABSOLUTE TOP PRIORITY:** The user is extremely angry about the broken PDFs. You must successfully implement the text-to-image rendering for Arabic text in . This is a make-or-break task. Do not move on to other tasks until a PDF with correct Arabic text is generated. Also, fix the regression causing blank English PDFs.
-   **User Consent is Key:** The second priority is implementing the employee signature (blue QR code) in the PDF for sick leaves that involve salary deductions. This is a hard requirement from the user.
-   **Communicate in Arabic:** All interactions, plans, and summaries for the user must be in Arabic.
-   **Attention to Detail:** The user has a very low tolerance for bugs and expects features to match their specifications exactly. Test your changes thoroughly.

**documents and test reports created in this job**
-   /app/backend/routes/pdf_v2.py
-   /app/backend/routes/test_pdf.py

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Demands a guaranteed solution for the PDF squares issue and suggests using a reliable library.
2.  **User:** Reports the English PDF is now mostly blank, the STAS seal (QR code) is missing, and the employee signature for deductions (blue QR code) is not implemented. Re-iterates that sick leave shouldn't be blocked before 120 days, only require consent for deductions.
3.  **User:** Reports that Arabic text (employee name, leave type, reason) and dates are still appearing as squares or incorrectly formatted in the PDF.
4.  **User:** Clarifies the sick leave process: don't block requests before 120 days, but show a warning about salary deductions and require the employee to sign (agree) to proceed.
5.  **User:** Asks why STAS isn't informed of the employee's sick leave consumption (out of 120 days) and why 'sultan' isn't notified of pay-bracket changes. Requests inline file preview instead of download.
6.  **User:** Reports that opening the attached medical file results in a Not authenticated error.
7.  **User:** Asks for a comment field for STAS when cancelling a transaction. Reports that cancelled leave requests are still blocking new ones. Asks for an indicator in the STAS mirror if a medical file was attached.
8.  **User:** Reports that the attached medical file is not visible to the admin.
9.  **User:** Requests that the message You can request all leave types... be hidden from the employee UI. Asks where the PDF upload for sick leave is. Asks for the 30/60/30 policy to be implemented. Points out bad date formatting () and requests the full contract be editable.
10. **Agent:** Acknowledges the feedback and starts implementing fixes for PDF upload, date formatting, and contract editing.

**Project Health Check:**
-   **Broken**: PDF Generation for both Arabic (squares, incorrect layout) and English (blank page) is completely non-functional and is a major regression. This is the highest priority issue.

**3rd Party Integrations**
-    (Current PDF library, problematic)
-    (To be used for the new text-to-image PDF workaround)
-    (For QR code generation)
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** The English language PDF is now blank. The core Arabic rendering issue persists.

**Credentials to test flow:**
-   Use the user-switcher dropdown in the app's header. Roles include , , , and . No passwords are required.

**What agent forgot to execute**
-   The agent has not yet implemented the blue QR code for employee consent in the PDF.
-   The agent has not implemented the notification system for 'sultan' regarding sick leave status changes.
-   The agent introduced a major regression where the English version of the PDF is blank and has not fixed it.
-   The agent did not fully resolve the root cause of inconsistent date formatting across the application.</analysis>
