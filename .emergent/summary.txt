<analysis>**original_problem_statement:**
The user is building DAR AL CODE HR OS, a comprehensive, mobile-first HR operating system. The initial goal was to enhance the System Maintenance module and implement a Settlement (المخالصة) feature. However, after extensive architectural analysis, the user pivoted to a more foundational task: building a robust, legally-compliant **Contracts (V2) module** as the absolute prerequisite for any further development, especially the settlement process.

The latest user request (Chat Message 336) is to refine the system's core HR logic based on this new contract foundation, before proceeding to the full settlement feature. This includes:
1.  **Clarifying and separating request types** (Leave vs. Attendance).
2.  Creating a **comprehensive attendance table** for admins.
3.  Implementing **leave accrual logic** (e.g., 21/30 days annual leave, 30/60/30 sick leave) within a Service Layer, driven by the new contract data.
4.  Enhancing the **STAS Mirror** to perform pre-execution validation by aggregating data from all ledgers (, , , ).
5.  Adding the ability to **assign a supervisor** from the employee list, which dictates the first step in the approval workflow.
6.  The user expects a detailed architectural explanation and a plan before any implementation begins.

**User's preferred language**: Arabic. The next agent **MUST** respond in Arabic.

**what currently exists?**
The agent has successfully completed two major user-requested tasks and conducted a deep architectural analysis of the system.

1.  **System Maintenance Enhancements (DONE):**
    *   **Backend ():** The API now returns the total database size. A new endpoint, , was created to allow uploading a  archive and restoring the database using . The maintenance logic was also updated to be aware of the new  collection.
    *   **Frontend ():** The page was completely redesigned. It now displays the total data size, features a file upload component with a progress bar for restoring archives, and has a more organized layout using Shadcn UI components.

2.  **System-Wide Date Format Audit (DONE):**
    *   A reusable utility, , was created in .
    *   This function was applied across the application (, , , etc.) to ensure all dates are consistently displayed in the  format as requested.

3.  **Contracts V2 Module (CRITICAL FOUNDATION - DONE):**
    *   A complete, from-scratch contract management system was built as the new foundation of the HR OS.
    *   **Backend:** A new  was introduced with  to handle all business logic. New Pydantic models () and API routes () were created for full lifecycle management (, , , , ), versioning, and automatic serial number generation ().
    *   **Frontend:** A new page, , was created for admins to list, view, and manage contracts. It includes statistics, status filtering, role-based actions (e.g., Terminate for STAS), and correct date formatting.
    *   Existing employees in the database have been migrated with new  contracts.

4.  **Architectural Analysis (DONE):**
    *   The agent provided multiple, in-depth technical reports analyzing the existing architecture, answering the user's specific questions about ledgers, the STAS mirror, the contract lifecycle, and the overall system design. This analysis has guided the project's direction.

**Last working item**:
-   **Last item agent was working:** The agent provided a final, comprehensive architectural assessment and a detailed plan to address the user's latest request (Chat Message 336). This plan covers refining request types, enhancing the attendance table, implementing leave accrual logic in the service layer, and improving the STAS mirror pre-checks. The agent is awaiting the user's approval of this plan before starting implementation.
-   **Status:** **USER VERIFICATION PENDING**
-   **Agent Testing Done:** Y (For all completed features, including Contracts V2).
-   **Which testing method agent to use?** **both**. The proposed changes involve significant backend service layer logic and frontend UI enhancements (e.g., the attendance table), requiring full-stack testing.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   Issue 1: **Implement Core HR Logic & STAS Mirror Enhancements (P0)**

**Issues Detail:**
-   **Issue 1: Implement Core HR Logic & STAS Mirror Enhancements**
    -   **Attempted fixes:** None (implementation has not started). The agent has completed the analysis and planning phase.
    -   **Next debug checklist:** Upon user approval, execute the plan outlined in the last agent message ().
        1.  **Refine Request Types:** Differentiate  from attendance-related requests in the  logic.
        2.  **Build Comprehensive Attendance Table:** Enhance  to show a full attendance summary (present, absent, on leave, etc.) for admins. Add functionality for manual edits with audit logs.
        3.  **Build Leave Accrual Service:** Create a new service (e.g., ) to calculate employee leave balances based on service years (from ) and apply sick leave rules. This service must be the single source of truth for leave balances, reading from the .
        4.  **Enhance STAS Pre-Checks:** Refactor  in  to call a new  service. This service will aggregate data from all ledgers to provide a comprehensive financial snapshot (blockers and warnings) on the STAS Mirror.
        5.  **Implement Supervisor Assignment UI:** Add a feature to the employee list page for admins to set an employee's . The workflow must then route requests to this supervisor first.
    -   **Why fix this issue and what will be achieved with the fix?** This will build the essential business logic required for an automated, compliant HR system on top of the new  foundation, paving the way for the final settlement module.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Full Settlement (المخالصة) Module:** Build the complete UI and backend for creating, processing, and executing employee settlements, using the new service layer for all calculations.
    -   **P1: STAS Control Center Dashboard:** Implement the proposed advanced dashboard for the STAS role, focusing on monitoring, alerts, and audit trails.
-   **Future Tasks:**
    -   Complete employee lifecycle automation (onboarding, offboarding).
    -   Policy Engine for configurable HR rules.
    -   Advanced reporting module.
    -   UI for new user/employee creation.

**Completed work in this session**
-   System Maintenance Module v2 (Total size, Upload/Restore).
-   System-Wide Gregorian/Hijri Date Format Audit.
-   **Comprehensive Contracts V2 Module:** A foundational contract management system with a service layer, API, lifecycle management, and dedicated UI.

**Earlier issues found/mentioned but not fixed**
-   **CEO Dashboard:** A dedicated view for the 'ceo' role is a pending task from a previous session.
-   **Full Settlement Calculation Engine:** The core calculation logic for settlements is the main upcoming task.

**Known issue recurrence from previous fork**
-   **Date/Time Formatting:** **RESOLVED**. A system-wide audit was performed and all dates were standardized.

**Code Architecture**


**Key Technical Concepts**
-   **Service Layer Architecture:** A significant architectural shift has begun, moving business logic from API routes into dedicated service files (e.g., ). This is a key principle to continue.
-   **Ledger-Based Source of Truth:** The system is moving towards using ledgers (, ) as the definitive source for all calculations, avoiding duplicated state.
-   **STAS Mirror:** A critical concept for a pre-execution validation screen for the super-admin role, ensuring all conditions are met before a transaction is finalized. This is a focus for future enhancement.
-   **Contract-Centric Design:** The new  module is now the core of the system. All employee activities (attendance, leave, etc.) must be governed by an active contract.

**key DB schema**
-   ****: 

**All files of reference**
-   : The template for the new Service Layer architecture.
-   : The API for the new core contract system.
-   : The UI for managing the new contracts.
-   : The location of the current STAS mirror and execution logic that needs to be refactored to use the service layer.
-   : Contains the detailed plan and architectural explanation that the next agent must get approved by the user before starting work.

**Areas that need refactoring**:
-   ****: The primary target for refactoring. The monolithic  and  functions must be broken down and their logic moved into dedicated services (e.g., , ).
-   **Enforce Contract Status:** Logic needs to be added throughout the application (e.g., in , ) to check for an  V2 contract before allowing any action.
-   **Single Source of Truth:** Any remaining logic that reads from stale/duplicated fields (e.g., ) should be refactored to calculate values directly from the relevant ledger.

**key api endpoints**
-   : List all V2 contracts.
-   : Create a new V2 contract.
-   : Change the status of a contract (e.g., send to STAS, activate).
-   : Terminate an active contract.
-   : The endpoint for the STAS pre-execution view, which is the focus of the next set of improvements.

**Critical Info for New Agent**
-   **Your immediate task is to get user approval for the plan you proposed in the last message.** Do not start coding. Use the  tool to present the plan from Chat Message 337's response and await confirmation.
-   The user is highly technical and values detailed architectural discussion **before** implementation. Continue this pattern of analyze, propose, get approval, then build.
-   The  module is the new, unchangeable foundation. All new logic must build upon it.
-   The primary architectural goal is to expand the **Service Layer**. All new business logic for leave, attendance, and settlements must be created in new service files, not added directly to the API routes.
-   **Do not build new ledgers or major systems.** The user has been clear: enhance and connect the existing pieces as per the agreed-upon plan.

**documents and test reports created in this job**
-   
-   
-    (updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Posed a long, detailed list of requirements and questions for the next phase, focusing on clarifying request types, building a comprehensive attendance table, implementing leave accrual logic, defining supervisor assignment, and refining the STAS mirror's function. Requested a detailed plan before execution. (Status: **PENDING AGENT RESPONSE/PLAN**)
2.  **Agent:** Provided a detailed architectural assessment of the current system, answering the user's questions about its state (Workflow vs. Ledger system), separation of layers, and the role of STAS. Proposed a phased roadmap. (Status: **DONE**)
3.  **User:** Asked for a deep architectural evaluation of the current system, covering its core identity, how to add new logic, the role of ledgers, separation of concerns, and the decision-making hierarchy. (Status: **ADDRESSED**)
4.  **Agent:** Finished implementing the Contracts V2 module, updated the PRD, and asked the user what was next. (Status: **DONE**)
5.  **User:** Provided extremely specific, non-negotiable requirements for a new Contracts V2 module, including the data model, lifecycle, serial numbering, PDF templates, and role permissions. Stated this must be completed before any settlement work. (Status: **ADDRESSED/COMPLETED**)
6.  **Agent:** Proposed a detailed architectural vision for the STAS Mirror, outlining what it currently does and what a fully-featured version for settlements should look like, including financial calculations, blockers, warnings, and an audit trail. (Status: **DONE**)
7.  **User:** Asked for a complete architectural explanation of the STAS Mirror concept, including what data it shows, how it validates transactions, and how it prevents errors. (Status: **ADDRESSED**)
8.  **Agent:** Provided a detailed technical report answering the user's questions about the readiness of the system for a settlement feature. (Status: **DONE**)
9.  **User:** Asked a series of deep technical questions about the system's readiness for a settlement feature, covering contract data, calculation engines, ledgers, and attendance. (Status: **ADDRESSED**)
10. **Agent:** Provided an initial technical report on the system's data and logic available for calculating settlements. (Status: **DONE**)

**Project Health Check:**
-   **Broken:** None.
-   **Mocked:** None.

**3rd Party Integrations**
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES. Used successfully for the Contracts V2 module.
-   **Test files created:** None.

**Credentials to test flow:**
Use the user-switcher dropdown in the app's header. Roles , , and  are relevant for contract management and upcoming tasks. No passwords are required.

**What agent forgot to execute**
The agent is correctly paused, waiting for explicit user approval on the detailed plan for the next phase of development. Nothing has been forgotten.</analysis>
