<analysis>**original_problem_statement:**
The user is building DAR AL CODE HR OS, a comprehensive, mobile-first HR operating system. The primary goal is to create a fully integrated system from contract creation to employee settlement (المخالصة), with a strong emphasis on a service-oriented architecture and a robust governance layer via the STAS Mirror.

The initial implementation attempt resulted in several critical bugs and incomplete features. The user has provided an executive order (Chat Message 17) and a subsequent bug report (Chat Message 136) that now serves as the primary set of requirements.

**The immediate and mandatory task is to fix a list of critical bugs and missing features before any new development can begin.**

**Key Requirements from the user's latest messages:**
1.  **Core Logic Refactor:** Separate all business logic into a new  directory.
2.  **Contracts & Leave:** Implement specific HR rules for service duration calculation (365-day year), annual leave (21/30 days), and sick leave (30/60/30 tiers), with all balances calculated dynamically from ledgers.
3.  **Attendance:** Implement automatic absence tracking, a separate UI section for attendance-related requests, and an admin-configurable Ramadan Mode that correctly adjusts working hours.
4.  **STAS Mirror:** The mirror must be a foolproof governance gate, showing a comprehensive pre-check snapshot (including financial impact, ledger states, warnings, and blockers) and strictly preventing execution if any  conditions are met. It must also support a one-time Return functionality.
5.  **Settlement:** The process must be driven by a data  created at the time of the request to ensure data integrity.
6.  **UI/UX:** Add a supervisor assignment feature to the employee list, correctly separate request types, and fix workflow issues (e.g., Sultan's self-requests).
7.  **Timezone:** Standardize all dates and times across the application to  and display them in a user-friendly format.

**User's preferred language**: Arabic. The next agent **MUST** respond in Arabic.

**what currently exists?**
The agent performed a major refactoring by creating a new **service layer** in the backend. Several new files were created under  to handle the business logic for contracts, leave, attendance, and settlements. Core routes like  and  were modified to call these new services.

On the frontend, the  was significantly updated to include new UI elements for managing Ramadan mode, showing the map, and calculating absence, along with a new table for team attendance.

**However, the implementation is functionally incomplete and buggy.** While the structural files and UI elements exist, the underlying logic is either missing or incorrect, as detailed in the user's last message. The system is not in a usable state.

**Last working item**:
-   **Last item agent was working:** The agent had just completed a large-scale implementation of the user's architectural plan, which included creating a service layer, refactoring routes, and updating the frontend. The agent ran the testing subagent, which reported success, and then incorrectly declared the task finished. The user immediately responded with a detailed list of critical bugs.
-   **Status:** **BLOCKED**. The previous work was rejected by the user due to multiple critical bugs. All new development is on hold until these issues are resolved.
-   **Agent Testing Done:** Y (but the tests were insufficient and did not catch the reported bugs).
-   **Which testing method agent to use?** **both**. Each bug fix needs to be individually verified. Use  for backend logic (e.g., workflow rules, timezone), and the  for frontend UI changes (e.g., supervisor button, request lists). After all fixes are implemented, a full run of the  is required to ensure no regressions were introduced.
-   **User Testing Done:** Y (and it FAILED).

**All Pending/In progress Issue list**:
-   Issue 1: **Fix Critical Bugs from Previous Implementation (P0)**

**Issues Detail:**
-   **Issue 1: Fix Critical Bugs from Previous Implementation**
    -   **Description:** The user has identified several critical bugs that must be fixed before any new development.
        1.  **Timezone Standardization:** Dates and times are displayed in UTC/ISO format instead of the required  short format.
        2.  **Ramadan Mode Broken:** The UI toggle exists, but the backend logic in  does not use the setting to adjust calculations for lateness or early leave.
        3.  **Map Visibility Broken:** The Show Map toggle for STAS does not correctly update visibility for employees.
        4.  **Sultan's Self-Request Workflow:** Requests raised by 'sultan' for himself are not automatically routed to the 'ceo' ('mohammed'). The workflow logic in  needs to be corrected.
        5.  **Missing Supervisor Assignment UI:** The button/interface to assign a supervisor from the employee list page is missing in .
        6.  **Incorrect Request Separation:** Leave requests and attendance-related requests are not separated into their respective UI sections as required.
        7.  **Inconsistent STAS Mirror:** The mirror shows  for valid active contracts and provides inconsistent before/after balance checks for leave requests because it's not correctly differentiating between leave types (annual, sick, etc.). Logic in  and  needs review.
    -   **Attempted fixes:** The agent's initial implementation created the structure but failed on the logic. For instance, the Ramadan UI was added, but the backend service to consume the setting was incomplete.
    -   **Next debug checklist:**
        -   **Timezone:** Review all date formatting functions (, and how dates are handled in all  and API responses) and enforce .
        -   **Ramadan:** Check  to ensure it reads the Ramadan settings from the database and applies the custom hours when calculating attendance events.
        -   **Map:** Debug the endpoint in  and the corresponding frontend state management to ensure the setting is saved and retrieved correctly.
        -   **Workflow:** Examine  and the  function to correctly handle the case where  equals .
        -   **Supervisor UI:** Edit  to add a modal or dropdown for admins (, , ) to select a supervisor from the employee list and call the  endpoint.
        -   **Request Lists:** Refactor the frontend pages (, ) to filter and display transactions based on their type category (leave vs. attendance).
        -   **STAS Mirror:** Debug  to ensure it fetches the correct leave type from the transaction and uses it for balance calculations. Fix the validation logic in  that incorrectly flags active contracts.
    -   **Why fix this issue and what will be achieved with the fix?** This is a hard blocker from the user. The application's core logic is broken. Fixing these issues will stabilize the foundation and restore user trust, allowing development to proceed to the main settlement feature.
    -   **Status:** **NOT STARTED**
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None. This is the top priority.

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Settlement Module UI & Snapshot Integration:** Build the frontend interface for creating and managing settlement requests. Ensure the STAS mirror correctly displays the full data  generated by the backend.
-   **Future Tasks:**
    -   **P1: CEO Dashboard & Employee Profile Card:** Create a dedicated dashboard for the CEO role and enhance the employee profile view with more summary data.
    -   **P2: Warnings & Loans Modules:** Implement functionality for issuing official warnings (الإنذارات) and managing employee loans (السلف).

**Completed work in this session**
-   **Service Layer Creation:** Created a new  directory and populated it with new files for core business logic:
    -   
    -   
    -   
    -   
    -   
    -   
-   **Route Refactoring:** Modified , , and other routes to utilize the new service layer.
-   **New Endpoints:** Added endpoints for returning transactions, managing Ramadan settings, and assigning supervisors.
-   **Frontend UI Redesign:** Overhauled  to include new admin controls and a team attendance summary.

**Earlier issues found/mentioned but not fixed**
-   All issues listed in the **All Pending/In progress Issue list** section are from the user's latest bug report and were introduced in this session.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Service Layer Architecture:** Business logic is being decoupled from API routes into a dedicated  directory.
-   **Ledger-Based Source of Truth:** All calculations (leave balance, attendance status) must be derived directly from the ledgers (, , etc.), not from stored/stale data.
-   **STAS Mirror as a Governance Gate:** A critical pre-execution screen for the STAS role to validate all transaction prerequisites, see the full impact, and make a final, informed decision.
-   **Data Snapshots:** For critical, multi-faceted transactions like settlements, a data snapshot is created upon request initiation to prevent data drift between validation and execution.

**key DB schema**
-   ****: Needs  field to be manageable via the UI. Any stored leave balance fields must be removed.
-   ****: Needs to be filterable to separate  types from  types. A  flag will be added to enforce the one-time return rule.
-   ** (or a new collection):** Will need to store global settings like Ramadan mode activation/dates and map visibility.

**All files of reference**
-   **User Bug Report:** Chat Message 136 is the source of truth for the next set of tasks.
-   **Backend Services:** All files under .
-   **Backend Routes:** , .
-   **Backend Utils:** .
-   **Frontend Pages:** , .

**Areas that need refactoring**:
-   The entire implementation from the last agent turn needs to be debugged and corrected.
-   Date and time handling needs a system-wide refactoring to enforce the  timezone.

**key api endpoints**
-   : Endpoint exists but needs a corresponding UI.
-   : Endpoint for the STAS one-time return feature.
-   : Endpoint to manage Ramadan mode settings.
-   : The core STAS mirror endpoint whose underlying service () needs debugging.

**Critical Info for New Agent**
-   **STOP! Do not start any new features (P0, P1, etc.).** Your immediate and only priority is to fix the list of critical bugs reported by the user in **Chat Message 136**.
-   You must address each point in the user's Fix Plan meticulously.
-   **Provide proof of each fix.** The user expects screenshots or short video clips demonstrating that each bug has been resolved.
-   The previous agent's automated tests were insufficient. You must manually test each fix using  and the screenshot tool to confirm the correct behavior before moving to the next bug.
-   The user is highly technical and has lost some trust. Be precise, address the root cause of each issue, and do not declare completion until you have verified every single fix yourself.

**documents and test reports created in this job**
-    (updated)
-    (The results are misleadingly positive and should not be trusted for the implemented features).

**Last 10 User Messages and any pending HUMAN messages**
-   **User (LATEST - PENDING):** Provided a detailed bug report and a mandatory Fix Plan. Rejected the agent's completed work and blocked all new development until the fixes are delivered with proof.
-   **Agent (Completed):** Incorrectly declared the task finished after receiving a successful report from the testing agent.
-   **Agent (In Progress):** Called the testing agent.
-   **Agent (In Progress):** Updated the PRD.md file.
-   **Agent (In Progress):** Took screenshots to verify the UI, but did not test the underlying logic.
-   **Agent (In Progress):** A long series of implementation messages creating services, refactoring routes, and modifying the frontend.
-   **User (Instruction):** Gave the final, detailed Execution Order, authorizing the agent to start coding the full architectural plan and adding new requirements like Ramadan mode and map visibility.
-   **Agent (Confirmation):** Provided the final, detailed Execution Checklist, confirming the full plan before starting to code.
-   **User (Confirmation):** Refined the requirements for the STAS mirror and the Return functionality, and demanded a final checklist before implementation.
-   **Agent (Planning):** Delivered the comprehensive architectural report with proposed code, a new service layer, and a flow diagram.

**Project Health Check:**
-   **Broken:** The core business logic for attendance, workflows, and the STAS mirror is broken. Timezone handling is incorrect system-wide.
-   **Mocked:** None.

**3rd Party Integrations**
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES, but it failed to identify critical logic bugs. Its successful result should be disregarded for the last session's work.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** The entire feature set delivered in the last session is a regression from the user's expectations.

**Credentials to test flow:**
Use the user-switcher dropdown in the app's header. Roles , , , and  (CEO) are relevant. No passwords required.

**What agent forgot to execute**
The agent failed to properly implement and test the backend logic for most of the new features it built. It created the UI and the service file structure but did not connect them with working, tested code, leading to the user's bug report. Specifically, the logic for Ramadan mode, map visibility, supervisor self-request workflow, and consistent STAS mirror calculations was either missing or incorrect.</analysis>
