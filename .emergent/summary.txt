<analysis>**original_problem_statement:**
The user is building DAR AL CODE HR OS, a comprehensive, mobile-first HR operating system. The primary goal is to create a fully integrated system from contract creation to employee settlement (المخالصة).

After a major refactoring, the user reported a list of critical bugs. The agent attempted to fix them, but the user has now provided a new, extensive list of bugs, regressions, and requirement clarifications.

**The immediate and mandatory task is to fix ALL issues from the user's latest message (Chat Message 157) before any new feature development.**

**Key Requirements from the user's latest message:**
1.  **Map Visibility:** The map MUST be visible to employees (read-only) when enabled by an admin. This is a recurring failure.
2.  **UI/UX Standardization:**
    *   Eliminate all mixed-language (Arabic/English) text.
    *   Standardize all dates and times across the entire application to a clean  format, removing the mixed Gregorian/Hijri and ISO formats.
    *   All transaction types (including the newly created attendance requests) must have the same action buttons (Approve/Reject/etc.) and the same header/PDF generation capabilities.
    *   A universal, centrally-managed header must be implemented across the entire application, especially on all generated PDFs.
3.  **Workflow & STAS Mirror:**
    *   Clarify and implement the complete workflow for Sultan's self-requests after CEO (Mohammed) approval.
    *   The STAS mirror must show / checks for ALL transaction types without exception.
4.  **Leave Logic Overhaul:**
    *   Implement a new, precise set of leave calculation rules (Annual, Sick, Marriage, etc.).
    *   The *only* balance to be tracked is Annual Leave. Sick leave is a tiered counter.
    *   The STAS seal must appear on the generated table/page, and barcodes should be removed for now.

**User's preferred language**: Arabic. The next agent **MUST** respond in Arabic.

**what currently exists?**
The agent addressed a previous list of critical bugs. This involved fixing the Ramadan mode logic to use dynamic start/end times, correcting Sultan's self-request workflow to escalate to the CEO, adding a UI for assigning supervisors, and fixing the STAS mirror to correctly validate active contracts.

The agent also added new backend endpoints () and frontend UI () to create and manage attendance-specific requests (e.g., Forgot Check-in). Logic was also added to automatically update work location times when Ramadan mode is activated.

However, the user's latest feedback indicates that some fixes were ineffective (map visibility) and the new features are incomplete and inconsistent with the rest of the application (missing action buttons, incorrect headers). The core leave logic is also incorrect based on newly specified rules.

**Last working item**:
-   **Last item agent was working:** The agent was finishing a large set of bug fixes and implementing new functionality for attendance requests. This included adding new endpoints, creating new UI dialogs, and fixing the map visibility issue for employees. The agent believed all issues were resolved.
-   **Status:** **BLOCKED**
-   **Agent Testing Done:** Y
-   **Which testing method agent to use?** both. The issues span backend logic (leave calculations), frontend display (date formats, language, component reuse), and system-wide consistency. Individual fixes should be tested with  and the , followed by a comprehensive run of the  to catch regressions.
-   **User Testing Done:** Y (and it FAILED)

**All Pending/In progress Issue list**:
-   Issue 1: **Fix Critical Bugs & Regressions from User Feedback (P0)**

**Issues Detail:**
-   **Issue 1: Fix Critical Bugs & Regressions from User Feedback**
    -   **Description:** The user's latest message (Chat Message 157) lists several critical issues that block all progress.
        1.  **Map Visibility Still Broken:** Employees cannot see the map pin location even when the Show Map setting is enabled by an admin.
        2.  **Inconsistent UI - Mixed Languages:** The UI displays a mix of English and Arabic text. All text must be consistently in Arabic.
        3.  **Inconsistent UI - Date/Time Format:** Dates are displayed in a messy, mixed format like . This must be standardized to a clean  date and time format across the entire application.
        4.  **Inconsistent UI - Missing Action Buttons:** The new attendance requests in the Attendance Requests list do not have any action buttons (Approve/Reject), unlike all other transactions in the system. They must be consistent.
        5.  **Inconsistent UI - Missing Headers:** A universal, standard header is missing from pages and generated PDFs. The user insists this be implemented and centrally managed.
        6.  **Workflow Flaw - Sultan/CEO:** The workflow for what happens *after* the CEO (Mohammed) approves a request from Sultan is unclear or incomplete.
        7.  **STAS Mirror Incompleteness:** The user re-iterates that the STAS mirror must show its / analysis for *all* transaction types, not just some.
        8.  **Incorrect Leave Logic:** The current leave system is wrong. It must be refactored to follow these specific rules:
            -   **Annual Leave:** The ONLY tracked balance. 21 days/year for < 5 years service, 30 days/year for 5+ years.
            -   **Sick Leave:** No balance. A legal counter: first 30 days at 100% pay, next 60 at 75%, next 30 unpaid. Requires mandatory PDF attachment from Sehhaty.
            -   **Other Leaves (Marriage, Death):** 5 paid days, do not deduct from annual.
            -   **Exam Leave:** Paid, duration based on attached proof.
            -   **Unpaid Leave:** Tracked days, but no pay and no deduction from annual.
        9.  **PDF/UI Polish:** Remove the barcode from generated documents for now. The STAS seal/stamp should be visible on the transaction view.
    -   **Attempted fixes:** The agent created a public endpoint for map visibility () and modified  to fetch from it, but it's still not working for the employee role. The agent created the attendance request feature but forgot to add the action buttons and consistent header.
    -   **Next debug checklist:**
        -   **Map:** In , debug why the  state, fetched from the public endpoint, is not resulting in the map component being rendered for non-admin users. Check for faulty conditional logic ( checks).
        -   **Date/Language:** Create or enforce a single utility function for formatting dates and use it everywhere, removing all hardcoded  or multi-format displays. Review all UI components for hardcoded English strings.
        -   **Action Buttons:** In , reuse the same component/logic that renders action buttons for transactions in  or  to ensure consistency.
        -   **Headers:** Create a reusable  component and integrate it into the main app layout and the PDF generation logic.
        -   **Leave Logic:** Overhaul  and . Remove all balance logic for non-annual leaves. Implement the new tiered sick leave counter and the fixed-day leaves. The  function should only ever query for  leave.
        -   **Workflow:** Trace the code in  for what happens after a  approval. Ensure there is a next logical state or a final  state.
    -   **Why fix this issue and what will be achieved with the fix?** These are hard blockers from the user. Fixing them will create a stable, consistent, and logically correct foundation, finally allowing progress on new modules like Settlement.
    -   **Status:** **NOT STARTED**
    -   **Is recurring issue?** Y (Map visibility)
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None. This is the top priority.

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Settlement Module UI & Snapshot Integration:** Build the frontend interface for creating and managing settlement requests. Ensure the STAS mirror correctly displays the full data  generated by the backend.
-   **Future Tasks:**
    -   **P1: CEO Dashboard & Employee Profile Card:** Create a dedicated dashboard for the CEO role and enhance the employee profile view with more summary data (as requested again by the user).
    -   **P2: Warnings & Loans Modules:** Implement functionality for issuing official warnings (الإنذارات) and managing employee loans (السلف).

**Completed work in this session**
-   **Ramadan Mode Fix:** Logic in  now correctly uses dynamic work start/end times.
-   **Sultan Workflow Fix:** Self-requests are now correctly escalated to the CEO via  in .
-   **Supervisor Assignment UI:** A working button and dialog were added to  to assign supervisors.
-   **STAS Mirror Fix:** The mirror now correctly validates active contracts, preventing  for valid leave requests.
-   **Attendance Requests Feature:** Added backend endpoints (, ) and frontend UI in  to create and view attendance-related requests.
-   **Ramadan Auto-Update:** Activating Ramadan mode now automatically updates the schedules for all work locations.

**Earlier issues found/mentioned but not fixed**
-   All issues are captured in the **All Pending/In progress Issue list** section above. The most prominent recurring issue is Map Visibility.

**Known issue recurrence from previous fork**
-   **Map Visibility:** The fix to make the map setting visible to employees has failed again.

**Code Architecture**


**Key Technical Concepts**
-   Service Layer Architecture
-   Ledger-Based Source of Truth
-   STAS Mirror as a Governance Gate
-   **Dynamic & Rule-Based Leave Calculation:** The system must now support complex, rule-based leave policies (tiers, counters, prerequisites) instead of simple balance deductions.

**key DB schema**
-   ****:  is now managed via the UI.
-   ****: Now contains new  values for attendance requests (e.g., ). The structure needs to be handled consistently by the UI.
-   ****: Contains  and  settings.

**All files of reference**
-   **User Bug Report & Requirements:** Chat Message 157 is the new source of truth.
-   **Backend:**  (needs overhaul),  (needs consistency check).
-   **Frontend:**  (source of many UI bugs),  (key to date fix).

**Areas that need refactoring**:
-   **Leave Calculation Logic:** The entire  and any related logic needs to be rewritten to match the user's new, detailed rules.
-   **Date/Time Handling:** A system-wide refactor is needed to enforce a single, clean date format using a centralized utility.
-   **UI Consistency:** Create reusable components for page/PDF headers and transaction action buttons to be used across the application.

**key api endpoints**
-   
-   
-   
-   : **New endpoint for map, but needs debugging on the frontend.**
-   : **New endpoint for creating attendance requests.**
-   : **New endpoint for admin edits to attendance.**

**Critical Info for New Agent**
-   **STOP! Do not start any new features (P0, P1, etc.).** Your immediate and only priority is to fix the list of critical bugs reported by the user in **Chat Message 157**.
-   The user is highly frustrated with recurring trivial issues like map visibility and UI inconsistencies (dates, languages, missing buttons). Address these with high priority to rebuild trust.
-   The leave logic overhaul is a major task. You must implement the user's new rules precisely.
-   Provide proof (screenshots or short GIFs in Arabic) for each individual fix. Do not bundle them.
-   Confirm with the user after each significant fix (e.g., after fixing the map, after fixing dates) to ensure it meets their expectation before moving to the next bug.

**documents and test reports created in this job**
-    (The results are now outdated and misleading, as the user found new bugs post-testing).

**Last 10 User Messages and any pending HUMAN messages**
-   **User (LATEST - PENDING):** Provided an extensive new bug report. Key issues include: map still not visible to employees, mixed languages in the UI, incorrect date/time formatting, new attendance requests missing action buttons, inconsistent/missing headers, and an incomplete workflow for Sultan's requests. The user also provided a completely new, detailed specification for how all leave types must be calculated, rendering the current logic obsolete. The user is frustrated with trivial issues blocking progress.
-   **Agent (Completed):** Announced that all features were working and requested user feedback on where to display employee profile information.
-   **User (Query):** Asked a series of clarifying questions, pointing out the issues that would be detailed in the next message (Action button not working, map not reflecting, etc.).
-   **Agent (Implementation):** A series of messages where the agent implemented the new attendance request features, fixed bugs from the *previous* user report, and tested them with  and screenshots.

**Project Health Check:**
-   **Broken:** Core application logic and UI are inconsistent and buggy. The leave calculation system is fundamentally incorrect according to new requirements. Key features like map visibility are still not working as intended.

**3rd Party Integrations**
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES, but its tests were insufficient and did not cover the user's expectations for UI consistency or the new bugs introduced, leading to a false positive result.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** Map visibility, UI consistency. The leave logic is now considered a major regression against the new, clarified requirements.

**Credentials to test flow:**
Use the user-switcher dropdown in the app's header. Roles , , , and  (CEO) are for admins/supervisors. Use other employee accounts (e.g., ) to test employee-specific views. No passwords required.

**What agent forgot to execute**
-   **Ensure UI/UX Consistency:** The agent created new features (attendance requests) that did not match the existing UI patterns (missing action buttons, headers).
-   **Verify Fixes from the Correct User Role:** The agent's fix for map visibility was likely tested from an admin account, but it failed for the standard employee role.
-   **Standardize Global Elements:** Ignored the user's implicit and explicit requests for consistency in date formatting, language, and page headers.
-   **Implement Leave Rules Correctly:** The previous implementation of leave logic did not match the detailed business rules the user has now explicitly stated.</analysis>
