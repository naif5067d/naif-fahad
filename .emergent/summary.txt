<analysis>**original_problem_statement:**
The user wants to build a complete Settlement (المخالصة) and final clearance module, deeply integrated with the existing contract and HR systems of DAR AL CODE HR OS.

**PRODUCT REQUIREMENTS (Based on latest user requests):**

1.  **P0: Settlement Module Core Functionality:**
    *   Create a Settlement process initiated from the Contracts V2 page.
    *   **Bank Details:** Add Bank Name and IBAN fields to the contract model. These fields must be editable at any time, even on active contracts, and must be reflected in the final settlement.
    *   **Accurate Calculations (Backend):**
        *   : Must be calculated as  from the contract.
        *   : Calculated as , with the balance being pro-rated.
        *   : Calculated based on Saudi Labor Law.
    *   **Workflow:**
        *   An Admin/Sultan creates a settlement. A detailed preview screen () must be shown before execution.
        *   STAS gives final, one-time execution.
        *   After execution, the employee's contract is marked Terminated, and their account is locked.

2.  **P0: Settlement PDF Generation:**
    *   Generate a single-page, A4, portrait, hybrid Arabic/English document.
    *   Must include the company logo (retrieved from system settings).
    *   Must feature a **Barcode** for the transaction number and **QR codes** for signatures.
    *   Must contain specific, user-provided bilingual text for all sections.
    *   Must have a space for the employee's manual signature.

3.  **P1: Deductions, Bonuses, and HR Enhancements:**
    *   Create a UI for 'sultan' to add deductions or bonuses, which require STAS approval.
    *   Implement a comprehensive daily attendance view.
    *   Activate the Employee Card in the profile with live summaries.
    *   Implement notifications for expiring contracts with remaining leave.

**User's preferred language**: Arabic. The next agent **MUST** respond and interact in Arabic.

**what currently exists?**
The agent has successfully implemented the foundational pieces of the settlement module. This includes adding the crucial 'Bank Name', 'IBAN', and 'Nature of Work Allowance' fields to the contract model and updating both the contract creation and editing forms in the UI after an initial miss. The backend has been scaffolded with new models (), routes (), and services (, ). A basic settlement page has been added to the frontend, and a preliminary, but incomplete, PDF generation function () has been created. The agent was in the middle of refining this PDF generation when the user provided more detailed requirements.

**Last working item**:
-   **Last item agent was working:** The agent was working on fixing the Settlement PDF. The user reported that the company logo was missing. The agent identified that the logo is stored as a base64 string in the  collection in the database and was about to modify the PDF generation logic in  to fetch, decode, and embed this logo into the document header.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** backend testing agent. After implementing the fix, the agent should call the settlement PDF generation API endpoint and verify that the output PDF file correctly displays the company logo.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Missing Company Logo in Settlement PDF (P0)**
-   **Issue 2: Incorrect/Incomplete Acknowledgment Text in Settlement PDF (P0)**

**Issues Detail:**
-   **Issue 1: Missing Company Logo in Settlement PDF**
    -   **Attempted fixes:** The agent located the base64-encoded logo in the  collection. The next step is to implement the code to use it.
    -   **Next debug checklist:**
        1.  In , modify the  function.
        2.  Fetch the  document from the database.
        3.  Extract the base64 logo string.
        4.  Use  and  to create an in-memory image file.
        5.  Use  to open the in-memory file and add it as a   object to the PDF's header section.
    -   **Why fix this issue and what will be achieved with the fix?** To fulfill the user's requirement for a professional, branded settlement document.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** None.
-   **Issue 2: Incorrect/Incomplete Acknowledgment Text in Settlement PDF**
    -   **Attempted fixes:** None.
    -   **Next debug checklist:**
        1.  In , find the section rendering the acknowledgment text ().
        2.  Replace the current text with the exact bilingual text provided by the user in Chat Message 227.
        3.  Ensure the Arabic part uses the RTL  and the English part uses the LTR .
    -   **Why fix this issue and what will be achieved with the fix?** To ensure the legal declaration on the settlement document is accurate.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Complete the Settlement PDF generation as per detailed specs (P0)**
    -   **Where to resume:** Continue editing . Immediately address the two pending issues (Logo and Acknowledgment Text).
    -   **What will be achieved with this?** A settlement PDF that is closer to the user's final vision.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Backend.
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P0: Implement PDF Barcode and QR Codes:** In , use  to generate a barcode for the transaction ID and a library like  to generate QR codes for signatures as requested.
    -   **P0: Implement Settlement UI - Preview & Audit Mirror:** In , build the detailed preview screen. This screen must show the settlement sheet exactly as it will appear in the PDF and include an Audit Mirror panel that details how each calculation was made. It should also allow for temporary edits to values before execution.
    -   **P0: Implement Finalization Logic:** Create the execute settlement API endpoint in . This should update the contract status to 'Terminated', freeze employee balances, and lock their account.
    -   **P1: Implement Deductions & Bonuses Module:** Build the full feature for adding/approving deductions and bonuses and integrate them into the settlement calculation.

-   **Future Tasks:**
    -   Comprehensive attendance system.
    -   Employee Profile Card activation.
    -   Leave balance notifications for expiring contracts.
    -   CEO Dashboard, Warnings & Loans Modules.

**Completed work in this session**
-   **Added Bank/IBAN Fields to Contracts:** Modified the backend model () and frontend form () to include , , and .
-   **Fixed 'Edit Contract' Dialog Bug:** Corrected the edit contract modal to display and save the newly added bank and allowance fields, which were initially missing.
-   **Allowed Bank Details Update on Active Contracts:** Modified the backend update logic in  to permit changes to bank information at any time.
-   **Scaffolded Settlement Module:** Created placeholder files for the settlement feature's backend (models, routes, services) and frontend (page, routing, sidebar link).

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Lax GPS Validation:** The backend accepts check-in/out records even if the  flag is .
-   **Issue 2: Global-Only Ramadan Hours:** The system lacks support for per-location or per-project Ramadan hours.

**Known issue recurrence from previous fork**
-   None. The major Arabic PDF rendering bug from the previous fork remains fixed.

**Code Architecture**


**Key Technical Concepts**
-   **Hybrid PDF Generation (ReportLab):** Using separate  objects for RTL (Arabic) and LTR (English) text to create a single, bilingual document.
-   **Base64 Image Handling:** The immediate task requires decoding a base64 string fetched from the database and embedding it as an image into the  PDF.
-   **FastAPI Update Logic:** The agent had to modify a route to allow partial updates (only bank details) on an otherwise restricted model (active contracts).

**key DB schema**
-   ****: Updated with , , .
-   **** (New): Will store final settlement transaction details.
-   ****: A collection that stores global settings, including the company logo as a base64 string.

**All files of reference**
-   **Primary file to modify:**  (To add logo and fix text).
-   **File to reference for logo data:**  (Shows how settings are fetched).
-   **File to modify next:**  (To build the Preview & Audit UI).
-   **User requirements source:** Chat Messages 197 and 227 contain the most detailed PDF and workflow specifications.

**Critical Info for New Agent**
-   Your first priority is to fix the settlement PDF. Address the two pending issues: **add the company logo** and **correct the acknowledgment text** using the user's latest instructions.
-   The logo is stored in the  collection as a base64 string. You must fetch it from the database, decode it, and embed it in the PDF.
-   The user is highly detail-oriented. After fixing the PDF content, your next major task is building the frontend **Preview screen and Audit Mirror** on  as specified in Chat Message 197. Do not proceed to PDF finalization (Barcode/QR) until the preview UI is complete.
-   All communication with the user must be in **Arabic**.

**documents and test reports created in this job**
-    (Note: This report is from before the user found the edit-dialog and PDF-logo bugs, so its results are outdated).

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Clarified that the company logo exists in system settings and re-provided the exact, full acknowledgment text that is missing/incomplete in the current settlement PDF.
2.  **Agent:** Acknowledged the user's feedback and stated they will search for the logo and fix the text.
3.  **User:** Asked why the company logo is missing from the settlement PDF.
4.  **Agent:** Was creating a temporary placeholder logo.
5.  **User:** Provided extremely detailed requirements for the final settlement PDF, including the single-page A4 layout, hybrid language, QR/Barcodes for signatures, and the critical need for a Preview/Audit screen before execution.
6.  **Agent:** Confirmed the fix for the Edit Contract dialog and showed a screenshot of the working modal.
7.  **User:** Reported that the bank/IBAN fields were missing from the **edit** contract dialog, making it impossible to update details for existing employees.
8.  **Agent:** Finished the initial implementation of the settlement module (before the bug was found) and was preparing to finish the task.
9.  **Agent:** Ran the testing agent, which passed 100% (before the bug was found).
10. **User:** Provided the full, detailed requirements for the entire settlement module, including all calculations, workflows, and PDF specs.

**Project Health Check:**
-   **Broken:** The settlement PDF () is incomplete and does not meet the user's specifications (missing logo, incorrect text, no barcode/QR codes).
-   **Mocked:** The main settlement UI () is just a placeholder and requires the complex Preview and Audit Mirror components to be built.

**3rd Party Integrations**
-   
-   
-   
-   
-   

**Testing status**
-   **Testing agent used after significant changes:** YES, but the test was run before the user discovered a significant bug in the Edit Contract form and the issues with the PDF. The last fix (edit form) was only verified with a screenshot.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   Use the user-switcher dropdown in the app's header to switch between roles like  and . No passwords are required.

**What agent forgot to execute**
-   The agent initially forgot to add the new bank/IBAN fields to the Edit Contract dialog, focusing only on the Create Contract form. This was caught by the user and has since been corrected. The current focus is now aligned with the user's latest, very specific requirements for the PDF.</analysis>
