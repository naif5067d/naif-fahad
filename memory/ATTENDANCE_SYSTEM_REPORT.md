# تقرير آلية نظام التحضير الذاتي الكامل

## نظرة عامة

نظام التحضير الذاتي هو **شريان التطبيق الأساسي** - يفحص كل شيء يخص الموظف يومياً ويُقرر حالته تلقائياً.

---

## 1. توقيت التشغيل

| الحدث | التوقيت | الوصف |
|-------|---------|-------|
| التحضير الذاتي | **7:00 صباحاً** (توقيت الرياض) | يُنشئ سجلات اليوم الحالي |
| الملخص الشهري | أول كل شهر 3:00 صباحاً | يُحسب الجزاءات الشهرية |

---

## 2. خطوات الفحص (8 خطوات بالترتيب)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ترتيب الفحص الإجباري                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  الخطوة 1: العطلات الرسمية (holidays)                               │
│  ├─ يفحص: جدول public_holidays                                      │
│  └─ إذا وُجد ← الحالة: "عطلة رسمية" ✅ ينتهي                         │
│                                                                     │
│  الخطوة 2: نهاية الأسبوع (weekend)                                  │
│  ├─ يفحص: work_days من بطاقة موقع العمل                             │
│  ├─ الجمعة = عطلة (افتراضي)                                         │
│  └─ إذا عطلة ← الحالة: "عطلة نهاية أسبوع" ✅ ينتهي                   │
│                                                                     │
│  الخطوة 3: الإجازات المنفذة (leave)                                 │
│  ├─ يفحص: جدول transactions (type=leave_request, status=executed)   │
│  ├─ أنواع: سنوية، مرضية، اضطرارية، إدارية، زواج، وفاة...            │
│  └─ إذا وُجد ← الحالة: "إجازة [النوع]" ✅ ينتهي                      │
│                                                                     │
│  الخطوة 4: المهمات الخارجية (mission)                               │
│  ├─ يفحص: جدول transactions (type=mission, status=executed)         │
│  └─ إذا وُجد ← الحالة: "مهمة خارجية" ✅ ينتهي                        │
│                                                                     │
│  الخطوة 5: نسيان البصمة (forget_checkin)                            │
│  ├─ يفحص: جدول transactions (type=forgotten_punch, status=executed) │
│  └─ إذا وُجد ← الحالة: "حاضر (نسيان بصمة معتمد)" ✅ ينتهي            │
│                                                                     │
│  الخطوة 6: البصمة الفعلية GPS (attendance)                          │
│  ├─ يفحص: جدول attendance_ledger                                    │
│  ├─ إذا وُجد دخول ← يُحلل التأخير والخروج المبكر                    │
│  └─ الحالات: حاضر، متأخر، خروج مبكر، متأخر+خروج مبكر                │
│                                                                     │
│  الخطوة 7: الاستئذان الجزئي (permission)                            │
│  ├─ يفحص: جدول transactions (type=permission, status=executed)      │
│  └─ يُخصم من ساعات العمل المطلوبة                                   │
│                                                                     │
│  الخطوة 8: التبريرات (excuses)                                      │
│  ├─ تبرير تأخير، تبرير خروج مبكر                                    │
│  └─ تُعدّل دقائق التأخير/الخروج                                     │
│                                                                     │
│  ═══════════════════════════════════════════════════════════════   │
│  ❌ إذا لم يُوجد أي شيء ────────────► الحالة: "غياب"                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. حساب التأخير والخروج المبكر

### المعادلة:

```
┌──────────────────────────────────────────────────────────────────┐
│                      حساب التأخير                                │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  بداية الدوام (من بطاقة الموقع): 08:00                          │
│  وقت السماح للتأخير: 15 دقيقة                                   │
│  آخر وقت مسموح للدخول: 08:15                                    │
│                                                                  │
│  إذا بصم الموظف الساعة 08:20:                                   │
│  ← تأخير = 08:20 - 08:00 = 20 دقيقة                             │
│  ← الحالة: "متأخر"                                              │
│                                                                  │
│  إذا بصم الموظف الساعة 08:10:                                   │
│  ← 08:10 < 08:15 (داخل وقت السماح)                              │
│  ← الحالة: "حاضر" (لا تأخير)                                    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                    حساب الخروج المبكر                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  نهاية الدوام (من بطاقة الموقع): 17:00                          │
│  وقت السماح للخروج المبكر: 15 دقيقة                             │
│  أبكر وقت مسموح للخروج: 16:45                                   │
│                                                                  │
│  إذا خرج الموظف الساعة 16:30:                                   │
│  ← خروج مبكر = 17:00 - 16:30 = 30 دقيقة                         │
│  ← الحالة: "خروج مبكر"                                          │
│                                                                  │
│  إذا خرج الموظف الساعة 16:50:                                   │
│  ← 16:50 > 16:45 (داخل وقت السماح)                              │
│  ← الحالة: "حاضر" (لا خروج مبكر)                                │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. إعدادات موقع العمل (بطاقة الموقع)

| الإعداد | الوصف | القيمة الافتراضية |
|---------|-------|------------------|
| `work_start` | بداية الدوام | 08:00 |
| `work_end` | نهاية الدوام | 17:00 |
| `daily_hours` | ساعات الدوام اليومية | 8 ساعات |
| `grace_checkin_minutes` | وقت السماح للتأخير | 15 دقيقة |
| `grace_checkout_minutes` | وقت السماح للخروج المبكر | 15 دقيقة |
| `work_days` | أيام العمل | السبت-الخميس |
| `ramadan_settings` | إعدادات رمضان | يُحدد لاحقاً |

### رمضان:
```json
{
  "ramadan_settings": {
    "enabled": true,
    "work_start": "09:00",
    "work_end": "15:00",
    "daily_hours": 6,
    "start_date": "2026-03-01",
    "end_date": "2026-03-30"
  }
}
```

---

## 5. أين تظهر النتائج؟

### للموظف:
| الصفحة | ما يظهر |
|--------|---------|
| لوحة التحكم | حالة اليوم + آخر 7 أيام |
| صفحة الحضور | سجل الحضور الكامل مع التفاصيل |
| صفحة ماليتي | الجزاءات والخصومات |

### للإدارة (stas, sultan, naif):
| الصفحة | ما يظهر |
|--------|---------|
| الحضور والجزاءات | جميع الموظفين + التفاصيل |
| مرآة STAS | trace_log كامل لكل قرار |
| لوحة الحوكمة | إحصائيات شاملة |

---

## 6. نظام العقوبات (الجزاءات)

### التأخير:
| المدة | الجزاء |
|-------|--------|
| 1-15 دقيقة | تحذير (داخل وقت السماح) |
| 16-30 دقيقة | إنذار أول |
| 31-60 دقيقة | خصم ربع يوم |
| 61-120 دقيقة | خصم نصف يوم |
| أكثر من 120 دقيقة | خصم يوم كامل |

### الغياب:
| النوع | الجزاء |
|-------|--------|
| غياب بدون عذر | خصم يوم + إنذار |
| غياب متكرر (3+ في الشهر) | خصم + تصعيد |

### أين تُحفظ العقوبات:
- جدول `deduction_proposals` ← اقتراحات تنتظر الموافقة
- جدول `deductions_bonuses` ← العقوبات المنفذة

---

## 7. trace_log (سجل التتبع)

كل قرار يُحفظ معه سجل كامل يوضح **لماذا** تم اتخاذ هذا القرار:

```json
{
  "trace_log": [
    {"step": "holiday", "found": false},
    {"step": "weekend", "found": false},
    {"step": "leave", "found": false},
    {"step": "mission", "found": false},
    {"step": "forget_checkin", "found": false},
    {"step": "attendance", "found": true, "analysis": {
      "is_late": true,
      "late_minutes": 25,
      "work_start": "08:00",
      "grace_period": 15
    }}
  ],
  "trace_summary": {
    "deciding_step": "attendance",
    "conclusion_ar": "حاضر مع تأخير 25 دقيقة"
  }
}
```

---

## 8. الجداول المستخدمة

| الجدول | الوظيفة |
|--------|---------|
| `daily_status` | النتيجة النهائية لكل يوم |
| `attendance_ledger` | بصمات GPS |
| `transactions` | الإجازات، المهمات، الاستئذانات |
| `public_holidays` | العطلات الرسمية |
| `work_locations` | بطاقات مواقع العمل |
| `deduction_proposals` | اقتراحات الجزاءات |
| `job_logs` | سجل تشغيل النظام الذاتي |

---

## 9. الملفات الأساسية في الكود

| الملف | الوظيفة |
|-------|---------|
| `/backend/services/scheduler.py` | جدولة التشغيل التلقائي |
| `/backend/services/day_resolver_v2.py` | محرك القرار الأساسي |
| `/backend/services/penalty_service.py` | حساب الجزاءات |
| `/backend/routes/attendance.py` | API الحضور |

---

## 10. المشاكل المكتشفة والحلول

### المشكلة 1: إعدادات رمضان غير موجودة
**الحل:** يجب إضافة `ramadan_settings` لبطاقات مواقع العمل

### المشكلة 2: الدوام حالياً 10:00-16:00 (6 ساعات)
**السؤال:** هل هذا صحيح أم يجب أن يكون 8:00-17:00 (8 ساعات)؟

### المشكلة 3: وقت السماح بعض المواقع "غير محدد"
**الحل:** يجب تعيين قيمة افتراضية لجميع المواقع

---

*آخر تحديث: 2026-02-22*
